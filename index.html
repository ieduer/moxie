<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="北大附中 孙玉磊">
    <meta name="robots" content="index, follow">
    <link rel="icon" href="https://img.bdfz.net/20250503004.webp" type="image/jpeg">
    <link rel="icon" href="/favicon.ico" sizes="any">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <title>AI 默寫</title>
    <style>
        /* --- Font --- */
        @font-face {
            font-family: 'HuWenMingChao';
            /* Assuming the paths are correct relative to the HTML file's location */
            src: url('./data/fonts/HuWenMingChaoTi.woff2') format('woff2'),
                url('./data/fonts/HuWenMingChaoTi.woff') format('woff');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        /* --- Ghibli Theme Variables --- */
        :root {
            --ghibli-bg: #fbfaf5;
            --ghibli-text: #5d5551;
            --ghibli-text-light: #9a8f8a;
            --ghibli-primary: #8aa3a3;
            --ghibli-primary-dark: #708a8a;
            --ghibli-accent1: #e0d8cc;
            --ghibli-accent2: #b8cca7;
            --ghibli-border-color: #d1c9bf;
            --ghibli-shadow: 0 3px 6px rgba(93, 85, 81, 0.08);
            --ghibli-footer-bg: #f2efea;
            --ghibli-error-bg: #faeae7;
            --ghibli-error-border: #e8cac6;
            --ghibli-error-text: #b55b5b;
            --ghibli-success-bg: #eaf3e6;
            --ghibli-success-border: #c9dcc3;
            --ghibli-success-text: #5a8e64;
            --ghibli-warning-bg: #fef9e9;
            --ghibli-warning-border: #f9efd1;
            --ghibli-warning-text: #a88a57;
            --ghibli-q-1: #ede9e1;
            --ghibli-q-2: #e8ede5;
            --ghibli-q-3: #ebe5e1;
            --ghibli-q-4: #e5eaed;
            --font-primary: 'HuWenMingChao', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            --footer-height: 60px;
            /* Define footer height as a variable */
        }

        /* --- Base & Body Styles --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-primary);
            line-height: 1.7;
            color: var(--ghibli-text);
            margin: 0;
            background-color: var(--ghibli-bg);
            /* Faded background image - path assumed correct */
            background-image:
                linear-gradient(rgba(251, 250, 245, 0.85), rgba(251, 250, 245, 0.9)),
                url('./data/img/5.jpeg');
            background-size: cover, cover;
            background-position: center center, center center;
            background-repeat: no-repeat, no-repeat;
            background-attachment: fixed, fixed;
            min-height: 100vh;
        }

        /* --- Layout Container --- */
        .page-container {
            display: flex;
            height: calc(100vh - var(--footer-height));
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }

        .left-column,
        .right-column {
            height: 100%;
            overflow-y: auto;
            padding: 30px;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .left-column::-webkit-scrollbar,
        .right-column::-webkit-scrollbar {
            display: none;
        }

        .left-column {
            flex: 1;
            min-width: 300px;
            border-right: 1px solid var(--ghibli-border-color);
        }

        .right-column {
            flex: 1.2;
            min-width: 320px;
            display: flex;
            flex-direction: column;
            background-color: rgba(255, 255, 255, 0.5);
        }

        /* --- Footer (Fixed) --- */
        footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--ghibli-footer-bg);
            border-top: 1px solid var(--ghibli-border-color);
            padding: 15px 0;
            height: var(--footer-height);
            text-align: center;
            font-size: 0.9em;
            color: var(--ghibli-text-light);
            z-index: 10;
            box-shadow: 0 -2px 5px rgba(93, 85, 81, 0.05);
        }

        footer a {
            color: var(--ghibli-text-light);
            text-decoration: underline;
        }

        footer a:hover {
            color: var(--ghibli-primary);
        }

        /* --- Responsive --- */
        @media (max-width: 800px) {
            body {
                min-height: 0;
                padding-bottom: var(--footer-height);
            }

            .page-container {
                flex-direction: column;
                height: auto;
                position: static;
            }

            .left-column,
            .right-column {
                height: auto;
                overflow-y: visible;
                width: 100%;
                flex: none;
                border-right: none;
                border-bottom: 1px solid var(--ghibli-border-color);
                padding: 20px;
            }

            .right-column {
                border-bottom: none;
            }
        }

        /* --- General Styles --- */
        h1,
        h2 {
            font-family: var(--font-primary);
            color: var(--ghibli-primary-dark);
            text-align: center;
            margin-bottom: 20px;
            font-weight: normal;
        }

        h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
        }

        h2 {
            font-size: 1.6em;
            border-bottom: 1px solid var(--ghibli-border-color);
            padding-bottom: 10px;
            margin-top: 30px;
        }

        p {
            margin-bottom: 15px;
        }

        strong {
            color: var(--ghibli-error-text);
            font-weight: normal;
        }

        a {
            color: var(--ghibli-primary);
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
            color: var(--ghibli-primary-dark);
        }

        #status,
        #questions,
        #result,
        #upload-section,
        #chapter-selection,
        .feedback-box,
        .processing-hints,
        .error-message,
        .rank-badge-section {
            margin-top: 25px;
            padding: 20px;
            border: 1px solid var(--ghibli-border-color);
            border-radius: 12px;
            background-color: rgba(255, 255, 255, 0.7);
            box-shadow: var(--ghibli-shadow);
        }

        #status {
            text-align: center;
            font-style: italic;
            color: var(--ghibli-text-light);
            background-color: transparent;
            border: none;
            box-shadow: none;
            padding: 10px 0;
        }

        #questions {
            background-color: rgba(242, 239, 234, 0.6);
        }

        #upload-section {
            border-top: 2px dashed var(--ghibli-primary);
            margin-top: 30px;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
            justify-content: center;
        }

        .experience-tips {
            margin: 0 auto 20px;
            padding: 12px 14px;
            border: 1px solid var(--ghibli-border-color);
            border-radius: 10px;
            background-color: rgba(255, 255, 255, 0.65);
            color: var(--ghibli-text-light);
            font-size: 0.93em;
            text-align: center;
        }

        .experience-tips p {
            margin: 0;
        }

        .account-panel {
            margin-bottom: 22px;
            padding: 14px;
            border: 1px solid var(--ghibli-border-color);
            border-radius: 10px;
            background-color: rgba(255, 255, 255, 0.68);
        }

        .account-form {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        #username-input,
        #password-input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--ghibli-border-color);
            border-radius: 8px;
            font-family: var(--font-primary);
            color: var(--ghibli-text);
            background-color: rgba(255, 255, 255, 0.9);
            min-width: 160px;
        }

        #username-input:focus,
        #password-input:focus {
            outline: 2px solid rgba(138, 163, 163, 0.25);
            border-color: var(--ghibli-primary);
        }

        #account-status {
            font-size: 0.9em;
            color: var(--ghibli-text-light);
            line-height: 1.5;
            margin: 0;
        }

        .password-change-panel {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed var(--ghibli-border-color);
        }

        .password-change-form {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        button {
            padding: 11px 24px;
            cursor: pointer;
            background-color: var(--ghibli-primary);
            color: var(--ghibli-bg);
            border: none;
            border-radius: 20px;
            font-size: 1em;
            font-family: var(--font-primary);
            transition: background-color 0.25s ease, transform 0.15s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 4px rgba(93, 85, 81, 0.15);
        }

        button:hover:not(:disabled) {
            background-color: var(--ghibli-primary-dark);
            box-shadow: 0 4px 8px rgba(93, 85, 81, 0.2);
        }

        button:active:not(:disabled) {
            transform: scale(0.97);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        button:disabled {
            background-color: var(--ghibli-accent1);
            color: var(--ghibli-text-light);
            cursor: not-allowed;
            opacity: 0.7;
            box-shadow: none;
        }

        button.loading-active {
            opacity: 0.8;
        }

        #submit-btn {
            background-color: var(--ghibli-accent2);
            color: var(--ghibli-text);
            width: calc(100% - 10px);
            margin-top: 20px;
        }

        #submit-btn:hover:not(:disabled) {
            background-color: #a6bb97;
        }

        .secondary-btn {
            background-color: var(--ghibli-accent1);
            color: var(--ghibli-text);
            border: 1px solid var(--ghibli-border-color);
            box-shadow: none;
            padding: 7px 14px;
            border-radius: 14px;
            font-size: 0.9em;
        }

        .secondary-btn:hover:not(:disabled) {
            background-color: #d8cec1;
            color: var(--ghibli-text);
        }

        #question-list {
            margin-top: 15px;
        }

        .question-item {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid transparent;
            transition: background-color 0.3s ease, border-color 0.3s ease;
            color: var(--ghibli-text);
        }

        .question-item:nth-child(4n+1) {
            background-color: var(--ghibli-q-1);
            border-color: var(--ghibli-border-color);
        }

        .question-item:nth-child(4n+2) {
            background-color: var(--ghibli-q-2);
            border-color: var(--ghibli-border-color);
        }

        .question-item:nth-child(4n+3) {
            background-color: var(--ghibli-q-3);
            border-color: var(--ghibli-border-color);
        }

        .question-item:nth-child(4n+4) {
            background-color: var(--ghibli-q-4);
            border-color: var(--ghibli-border-color);
        }

        .question-item p {
            margin: 0;
        }

        .question-text {
            display: block;
            margin-bottom: 5px;
            font-weight: normal;
            font-size: 1.1em;
            color: var(--ghibli-text);
        }

        /* Removed question-details span as per Req 3 */
        .underline-blank {
            border-bottom: 1.5px dashed var(--ghibli-text-light);
            padding: 0 0.5em;
            color: var(--ghibli-text-light);
            display: inline-block;
            min-width: 5em;
            text-align: center;
        }

        #image-upload-label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: var(--ghibli-primary-dark);
        }

        .upload-hint {
            margin: 8px 0 12px;
            font-size: 0.9em;
            color: var(--ghibli-text-light);
        }

        input[type="file"] {
            font-family: var(--font-primary);
            color: var(--ghibli-text);
            padding: 5px;
            margin-bottom: 15px;
        }

        input[type="file"]::file-selector-button {
            font-family: var(--font-primary);
            padding: 8px 15px;
            margin-right: 15px;
            cursor: pointer;
            background-color: var(--ghibli-accent1);
            color: var(--ghibli-text);
            border: 1px solid var(--ghibli-border-color);
            border-radius: 15px;
            transition: background-color 0.2s ease;
        }

        input[type="file"]::file-selector-button:hover {
            background-color: rgba(224, 216, 204, 0.85);
        }

        #image-preview-container {
            margin-top: 15px;
            text-align: center;
        }

        #image-preview {
            max-width: 90%;
            max-height: 350px;
            border: 1px solid var(--ghibli-border-color);
            border-radius: 8px;
            display: none;
            margin: 10px auto;
            box-shadow: var(--ghibli-shadow);
        }

        #compression-info {
            font-size: 0.9em;
            color: var(--ghibli-text-light);
            margin-top: 10px;
            text-align: center;
            min-height: 1.2em;
        }

        #result {
            background-color: rgba(255, 255, 255, 0.75);
        }

        .result-item {
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid var(--ghibli-border-color);
            border-radius: 8px;
            border-left-width: 6px;
            border-left-style: solid;
            transition: border-color 0.3s ease;
            background-color: var(--ghibli-bg);
        }

        .result-item p {
            margin: 8px 0;
        }

        .result-item strong {
            color: var(--ghibli-primary-dark);
            font-weight: bold;
        }

        .result-item .label {
            font-weight: bold;
            color: var(--ghibli-text-light);
            min-width: 75px;
            display: inline-block;
        }

        .recognized-text,
        .correct-answer-text,
        .incorrect-answer-text,
        .unrecognized-text {
            font-weight: normal;
            padding: 3px 6px;
            border-radius: 4px;
            display: inline-block;
            word-break: break-word;
            overflow-wrap: break-word;
            line-height: 1.5;
        }

        .correct-answer-text {
            color: var(--ghibli-success-text);
            background-color: var(--ghibli-success-bg);
            border: 1px solid var(--ghibli-success-border);
        }

        .incorrect-answer-text {
            color: var(--ghibli-error-text);
            background-color: var(--ghibli-error-bg);
            border: 1px solid var(--ghibli-error-border);
        }

        .unrecognized-text {
            color: var(--ghibli-text-light);
            background-color: var(--ghibli-accent1);
            font-style: italic;
            border: 1px solid var(--ghibli-border-color);
        }

        .correct-tick,
        .incorrect-cross {
            font-weight: bold;
            margin-left: 8px;
            font-size: 1.1em;
        }

        .correct-tick {
            color: var(--ghibli-success-text);
        }

        .incorrect-cross {
            color: var(--ghibli-error-text);
        }

        .processing-failed-text {
            color: var(--ghibli-warning-text);
            font-style: italic;
        }

        .error-message,
        .processing-hints,
        .feedback-box {
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-size: 1em;
            text-align: left;
            white-space: pre-wrap;
            word-wrap: break-word;
            border: 1px solid;
        }

        .error-message {
            background-color: var(--ghibli-error-bg);
            border-color: var(--ghibli-error-border);
            color: var(--ghibli-error-text);
            font-weight: bold;
        }

        .processing-hints {
            background-color: var(--ghibli-warning-bg);
            border-color: var(--ghibli-warning-border);
            color: var(--ghibli-warning-text);
        }

        .processing-hints p {
            margin: 5px 0;
            font-weight: bold;
        }

        .item-hint {
            color: var(--ghibli-warning-text);
            font-size: 0.9em;
            margin-top: 5px;
            font-style: italic;
        }

        .feedback-box {
            text-align: center;
            margin-top: 30px;
            font-size: 1.1em;
            line-height: 1.8;
        }

        .feedback-success {
            background-color: var(--ghibli-success-bg);
            border-color: var(--ghibli-success-border);
            color: var(--ghibli-success-text);
            font-weight: bold;
        }

        .feedback-fail {
            background-color: var(--ghibli-error-bg);
            border-color: var(--ghibli-error-border);
            color: var(--ghibli-error-text);
            font-weight: bold;
            font-size: 1.15em;
        }

        .feedback-box pre {
            background-color: transparent;
            padding: 0;
            border-radius: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: inherit;
            color: inherit;
            border: none;
            font-family: var(--font-primary);
            text-align: left;
            max-height: none;
            overflow: visible;
        }

        .loading {
            font-style: italic;
            color: var(--ghibli-text-light);
            text-align: center;
            padding: 30px;
            font-size: 1.1em;
            border: 1px dashed var(--ghibli-border-color);
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.6);
        }

        @keyframes celebrate-box {
            0% {
                transform: scale(1);
                box-shadow: var(--ghibli-shadow);
            }

            50% {
                transform: scale(1.01);
                box-shadow: 0 8px 16px rgba(90, 142, 100, 0.2);
            }

            100% {
                transform: scale(1);
                box-shadow: var(--ghibli-shadow);
            }
        }

        #result.full-marks-celebration {
            animation: celebrate-box 1.8s ease-in-out;
            border: 1px solid var(--ghibli-success-border);
            box-shadow: 0 5px 10px rgba(90, 142, 100, 0.15);
        }

        .rank-badge-section {
            text-align: center;
            margin-top: 25px;
            padding: 15px;
            background-color: rgba(224, 216, 204, 0.2);
            border: 1px solid var(--ghibli-border-color);
            border-radius: 8px;
        }

        .badge-display {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--ghibli-primary-dark);
        }

        .badge-display span {
            font-size: 1.6em;
            vertical-align: middle;
            margin: 0 5px;
            color: var(--ghibli-primary);
        }

        .rank-display {
            margin-top: 5px;
            font-size: 0.95em;
            color: var(--ghibli-text-light);
        }

        #leaderboard-panel {
            margin-top: 25px;
            padding: 18px;
            border: 1px solid var(--ghibli-border-color);
            border-radius: 12px;
            background-color: rgba(255, 255, 255, 0.76);
            box-shadow: var(--ghibli-shadow);
        }

        #leaderboard-panel h2 {
            margin-top: 0;
            font-size: 1.4em;
        }

        .leaderboard-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .leaderboard-tab {
            padding: 7px 12px;
            border-radius: 12px;
            border: 1px solid var(--ghibli-border-color);
            background-color: var(--ghibli-bg);
            color: var(--ghibli-text);
            font-size: 0.9em;
            box-shadow: none;
        }

        .leaderboard-tab.active {
            background-color: var(--ghibli-primary);
            color: var(--ghibli-bg);
            border-color: var(--ghibli-primary-dark);
        }

        #leaderboard-meta {
            color: var(--ghibli-text-light);
            font-size: 0.85em;
            margin-bottom: 10px;
        }

        .leaderboard-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .leaderboard-row {
            display: grid;
            grid-template-columns: 42px 1fr auto;
            gap: 10px;
            align-items: center;
            padding: 10px 12px;
            border-radius: 8px;
            background-color: var(--ghibli-bg);
            border: 1px solid var(--ghibli-border-color);
            font-size: 0.92em;
        }

        .leaderboard-row.me {
            border-color: var(--ghibli-primary);
            background-color: rgba(224, 242, 242, 0.45);
        }

        .leaderboard-rank {
            font-weight: bold;
            color: var(--ghibli-primary-dark);
            text-align: center;
        }

        .leaderboard-user {
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .leaderboard-user-name {
            font-weight: bold;
            color: var(--ghibli-text);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .leaderboard-user-tier {
            font-size: 0.82em;
            color: var(--ghibli-text-light);
        }

        .leaderboard-score {
            text-align: right;
            color: var(--ghibli-primary-dark);
            font-weight: bold;
        }

        .leaderboard-score small {
            display: block;
            color: var(--ghibli-text-light);
            font-weight: normal;
            font-size: 0.78em;
        }

        .leaderboard-empty {
            text-align: center;
            color: var(--ghibli-text-light);
            font-style: italic;
            border: 1px dashed var(--ghibli-border-color);
            border-radius: 8px;
            padding: 14px 12px;
            background-color: rgba(255, 255, 255, 0.55);
        }

        /* --- Styles for Chapter Selection --- (Requirement 9) */
        #chapter-selection {
            background-color: rgba(242, 239, 234, 0.7);
            padding: 25px;
        }

        #chapter-selection h2 {
            font-size: 1.4em;
            color: var(--ghibli-primary-dark);
            margin-bottom: 15px;
            border: none;
            text-align: left;
        }

        .chapter-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .chapter-list-item button {
            display: block;
            /* Make button take full width */
            width: 100%;
            text-align: left;
            padding: 12px 18px;
            margin-bottom: 8px;
            /* Space between items */
            font-family: var(--font-primary);
            font-size: 1.05em;
            color: var(--ghibli-text);
            background-color: var(--ghibli-bg);
            /* Use light bg */
            border: 1px solid var(--ghibli-border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
            box-shadow: var(--ghibli-shadow);
        }

        .chapter-list-item button:hover {
            background-color: var(--ghibli-accent1);
            border-color: var(--ghibli-primary);
            box-shadow: 0 4px 8px rgba(93, 85, 81, 0.12);
        }

        .chapter-list-item button .chapter-order {
            display: inline-block;
            min-width: 2em;
            /* Ensure alignment */
            margin-right: 10px;
            color: var(--ghibli-text-light);
            font-weight: bold;
        }

        .chapter-list-item button .chapter-title {
            font-weight: normal;
            color: var(--ghibli-text);
        }

        .chapter-list-item button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: var(--ghibli-accent1);
        }
    </style>
    <!-- External Libraries -->
    <script
        src="https://cdn.bootcdn.net/ajax/libs/browser-image-compression/2.0.2/browser-image-compression.js"></script>
</head>

<body>

    <!-- Page container holds the scrolling columns -->
    <div class="page-container">

        <!-- Left Column: Controls, Questions, Upload -->
        <div class="left-column">
            <h1>AI 默寫</h1>
            <p style="text-align: center; color: var(--ghibli-primary-dark);"><strong>高考默寫8分，放條<a
                        href="https://mf.bdfz.net" target="_blank">窺視者</a>都能拿滿！何況是你我！</strong></p>
            <p style="text-align: center; color: var(--ghibli-error-text); font-weight: bold;">
                依序分行，拍照上傳，清晰字跡！
            </p>
            <div class="button-group">
                <!-- (Requirement 4) Updated button text and added new button -->
                <button id="gaokao-challenge-btn">挑戰高考</button>
                <button id="select-chapter-btn">選篇挑戰</button>
            </div>
            <div class="account-panel">
                <div class="account-form">
                    <input id="username-input" type="text" maxlength="20" placeholder="輸入用戶名（中文/字母/數字）">
                    <input id="password-input" type="password" maxlength="64" placeholder="輸入密碼（至少 6 位，首次將自動註冊）">
                    <button id="login-btn" class="secondary-btn">登錄</button>
                    <button id="logout-btn" class="secondary-btn" style="display: none;">登出</button>
                </div>
                <p id="account-status">尚未登錄。請先輸入用戶名與密碼。</p>
                <div id="password-change-panel" class="password-change-panel" style="display: none;">
                    <div class="password-change-form">
                        <input id="old-password-input" type="password" maxlength="64" placeholder="當前密碼">
                        <input id="new-password-input" type="password" maxlength="64" placeholder="新密碼（至少 6 位）">
                        <button id="change-password-btn" class="secondary-btn">修改密碼</button>
                    </div>
                </div>
            </div>
            <div class="experience-tips">
                <p><strong>操作流程：</strong>先選模式 → 按順序分行作答 → 拍清晰照片 → 等待評閱</p>
            </div>
            <div id="status" role="status" aria-live="polite">狀態：選擇挑戰模式...</div>
            <div id="questions" style="display: none;">
                <!-- Title will be updated dynamically -->
                <h2 id="questions-title">筆墨伺候 (共 8 分)</h2>
                <button id="back-to-chapters-btn" class="secondary-btn" style="display: none;">返回篇目列表</button>
                <p style="text-align: center; color: var(--ghibli-text-light); font-style: italic;">
                    <strong style="color: var(--ghibli-error-text);">‼️勿寫題號，一題一行，不加標點‼️ </strong>
                </p>
                <div id="question-list"></div>
            </div>
            <div id="upload-section" style="display: none;">
                <h2>拍照上傳</h2>
                <label for="image-upload" id="image-upload-label">選擇或拍攝照片:</label>
                <p class="upload-hint">建議：光線充足、鏡頭平行紙面、答案完整入鏡。</p>
                <input type="file" id="image-upload" name="image-upload" accept="image/*" capture="environment">
                <div id="compression-info"></div>
                <div id="image-preview-container">
                    <img id="image-preview" src="#" alt="圖片預覽">
                </div>
                <button id="submit-btn" disabled>提交墨寶</button>
            </div>
        </div><!-- End Left Column -->

        <!-- Right Column: Results / Chapter Selection -->
        <div class="right-column">
            <div id="leaderboard-panel">
                <h2>排行榜</h2>
                <div class="leaderboard-tabs">
                    <button type="button" class="leaderboard-tab active" data-scope="total">總榜</button>
                    <button type="button" class="leaderboard-tab" data-scope="weekly">週榜</button>
                    <button type="button" class="leaderboard-tab" data-scope="daily">日榜</button>
                </div>
                <div id="leaderboard-meta">載入中...</div>
                <div id="leaderboard-list" class="leaderboard-list"></div>
            </div>
            <!-- Container for Chapter Selection (Requirement 6) -->
            <div id="chapter-selection" style="display: none;">
                <!-- Chapter list will be injected here by JS -->
            </div>
            <!-- Container for Results (used by both modes) -->
            <div id="result" style="display: none;">
                <!-- Result content injected here -->
            </div>
        </div><!-- End Right Column -->

    </div> <!-- End Page Container -->

    <!-- Footer is OUTSIDE the page container -->
    <footer>
        <p>© Suen | <a href="https://bdfz.net/posts/moxie" target="_blank" rel="noopener noreferrer">關於 Moxie</a></p>
    </footer>

    <!-- Main Application Logic -->
    <script>
        // --- DOM Elements ---
        const statusDiv = document.getElementById('status');
        const questionsDiv = document.getElementById('questions');
        const questionsTitle = document.getElementById('questions-title'); // Get questions title H2
        const questionListDiv = document.getElementById('question-list');
        const uploadSection = document.getElementById('upload-section');
        const imageUploadInput = document.getElementById('image-upload');
        const imagePreview = document.getElementById('image-preview');
        const compressionInfo = document.getElementById('compression-info');
        const resultDiv = document.getElementById('result');
        const chapterSelectionDiv = document.getElementById('chapter-selection'); // (Req 6) Get chapter selection div
        const gaokaoChallengeBtn = document.getElementById('gaokao-challenge-btn'); // (Req 4) Renamed button
        const selectChapterBtn = document.getElementById('select-chapter-btn'); // (Req 4) New button
        const backToChaptersBtn = document.getElementById('back-to-chapters-btn');
        const usernameInput = document.getElementById('username-input');
        const passwordInput = document.getElementById('password-input');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const passwordChangePanel = document.getElementById('password-change-panel');
        const oldPasswordInput = document.getElementById('old-password-input');
        const newPasswordInput = document.getElementById('new-password-input');
        const changePasswordBtn = document.getElementById('change-password-btn');
        const accountStatus = document.getElementById('account-status');
        const leaderboardListDiv = document.getElementById('leaderboard-list');
        const leaderboardMetaDiv = document.getElementById('leaderboard-meta');
        const leaderboardTabs = Array.from(document.querySelectorAll('.leaderboard-tab'));
        const submitBtn = document.getElementById('submit-btn');
        const rightColumn = document.querySelector('.right-column');
        const leftColumn = document.querySelector('.left-column'); // Cache left column too

        // --- State Variables ---
        let currentQuestions = []; // Holds questions for the *current* challenge (either GaoKao or Chapter)
        let currentChallengeType = null; // 'gaokao' or 'chapter'
        let currentChallengeIdentifier = null; // Holds setId for 'gaokao', chapterOrder for 'chapter'
        let currentChapterTitle = ''; // Store chapter title for display
        let compressedImageBlob = null;
        let isSubmitting = false;
        let isLoading = false; // General loading state flag
        let chapterCache = null;
        let chapterCacheTime = 0;
        let currentUser = null;
        let submitProgressTimer = null;
        let leaderboardScope = 'total';
        let leaderboardState = {
            period: { dailyKey: '', weeklyKey: '' },
            total: [],
            weekly: [],
            daily: [],
            me: null,
        };

        const API_BASE_URL = '/api';
        const API_TIMEOUT_MS = 20000;
        const API_RETRYABLE_STATUS = new Set([408, 425, 429, 500, 502, 503, 504]);
        const CHAPTER_CACHE_TTL_MS = 5 * 60 * 1000;
        const USERNAME_STORAGE_KEY = 'moxie_username';
        const AUTH_TOKEN_STORAGE_KEY = 'moxie_auth_token';

        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        function buildApiUrl(endpoint) {
            const normalizedEndpoint = endpoint.startsWith('/') ? endpoint : `/${endpoint}`;
            return `${API_BASE_URL}${normalizedEndpoint}`;
        }

        async function parseApiError(response) {
            const contentType = response.headers.get('content-type') || '';
            if (contentType.includes('application/json')) {
                try {
                    const payload = await response.json();
                    if (payload && typeof payload.error === 'string') {
                        return payload.error;
                    }
                } catch (error) {
                    console.warn('Failed to parse API error JSON:', error);
                }
            }

            try {
                const text = await response.text();
                const plainText = text.replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').trim();
                return plainText ? plainText.slice(0, 180) : '';
            } catch (error) {
                console.warn('Failed to read API error text:', error);
                return '';
            }
        }

        async function requestJson(endpoint, fetchOptions = {}, requestOptions = {}) {
            const retries = Number.isInteger(requestOptions.retries) ? requestOptions.retries : 1;
            const timeoutMs = Number.isInteger(requestOptions.timeoutMs) ? requestOptions.timeoutMs : API_TIMEOUT_MS;
            const url = buildApiUrl(endpoint);
            let lastError = null;

            for (let attempt = 0; attempt <= retries; attempt++) {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

                try {
                    const response = await fetch(url, {
                        ...fetchOptions,
                        signal: controller.signal,
                    });

                    if (!response.ok) {
                        let message = await parseApiError(response);
                        if (!message) {
                            message = `HTTP 錯誤！狀態: ${response.status} ${response.statusText}`;
                        }
                        if (response.status === 404) {
                            message = `API 路徑不存在 (${endpoint})。請確認 Cloudflare Pages 部署包含 functions 目錄。`;
                        }
                        const error = new Error(message);
                        error.status = response.status;
                        throw error;
                    }

                    return await response.json();
                } catch (error) {
                    lastError = error;
                    const status = typeof error.status === 'number' ? error.status : undefined;
                    const isTimeout = error.name === 'AbortError';
                    const retryable = isTimeout || (status !== undefined && API_RETRYABLE_STATUS.has(status));

                    if (attempt < retries && retryable) {
                        await sleep(350 * (attempt + 1));
                        continue;
                    }

                    if (isTimeout) {
                        throw new Error(`請求超時（>${Math.round(timeoutMs / 1000)} 秒）`);
                    }
                    throw error;
                } finally {
                    clearTimeout(timeoutId);
                }
            }

            if (lastError && lastError.message) {
                throw lastError;
            }
            throw new Error('API 請求失敗');
        }

        function readStoredUsername() {
            return localStorage.getItem(USERNAME_STORAGE_KEY) || '';
        }

        function writeStoredUsername(username) {
            if (username) {
                localStorage.setItem(USERNAME_STORAGE_KEY, username);
            } else {
                localStorage.removeItem(USERNAME_STORAGE_KEY);
            }
        }

        function readStoredToken() {
            return localStorage.getItem(AUTH_TOKEN_STORAGE_KEY) || '';
        }

        function writeStoredToken(token) {
            if (token) {
                localStorage.setItem(AUTH_TOKEN_STORAGE_KEY, token);
            } else {
                localStorage.removeItem(AUTH_TOKEN_STORAGE_KEY);
            }
        }

        function getAuthHeaders(extraHeaders = {}, tokenOverride = '') {
            const headers = { ...extraHeaders };
            const token = tokenOverride || currentUser?.token || '';
            if (token) {
                headers.Authorization = `Bearer ${token}`;
            }
            return headers;
        }

        function renderAuthControls() {
            const loggedIn = !!(currentUser && currentUser.token);
            usernameInput.readOnly = loggedIn;
            passwordInput.style.display = loggedIn ? 'none' : '';
            loginBtn.style.display = loggedIn ? 'none' : '';
            logoutBtn.style.display = loggedIn ? '' : 'none';
            passwordChangePanel.style.display = loggedIn ? '' : 'none';
            if (!loggedIn) {
                oldPasswordInput.value = '';
                newPasswordInput.value = '';
            }
        }

        function clearCurrentUser() {
            currentUser = null;
            writeStoredToken('');
            renderAuthControls();
            renderAccountStatus();
        }

        function renderAccountStatus() {
            if (!currentUser) {
                accountStatus.textContent = '尚未登錄。請先輸入用戶名與密碼。';
                return;
            }

            const totalStats = currentUser.stats?.total;
            if (!totalStats) {
                accountStatus.textContent = `已登錄：${currentUser.username}`;
                return;
            }

            accountStatus.textContent = `已登錄：${currentUser.username}｜段位：${totalStats.tier.tierName}（${totalStats.tier.modeName || '常規排位'}）｜總積分：${totalStats.points}｜參與：${totalStats.attempts} 次`;
        }

        function requireLogin() {
            if (currentUser && currentUser.username && currentUser.token) return true;
            displayError('請先輸入用戶名與密碼登錄，再開始挑戰。', statusDiv);
            usernameInput.focus();
            return false;
        }

        async function loginWithUsername(rawUsername, rawPassword, options = {}) {
            const username = (rawUsername || '').trim();
            const password = (rawPassword || '').trim();
            if (!username) {
                if (!options.silent) displayError('請輸入用戶名。', statusDiv);
                return false;
            }
            if (!password) {
                if (!options.silent) displayError('請輸入密碼。', statusDiv);
                passwordInput.focus();
                return false;
            }

            setLoadingState(loginBtn, true, '登錄中');
            try {
                const data = await requestJson(
                    '/login',
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password }),
                    },
                    { retries: 0 }
                );

                currentUser = {
                    userId: data.user.userId,
                    username: data.user.username,
                    token: data.token,
                    expiresAt: data.expiresAt,
                    stats: data.stats,
                };
                usernameInput.value = currentUser.username;
                writeStoredUsername(currentUser.username);
                writeStoredToken(currentUser.token);
                passwordInput.value = '';
                renderAuthControls();
                renderAccountStatus();
                statusDiv.textContent = data.isNewUser
                    ? `狀態：已創建新賬號 ${currentUser.username}，請選擇挑戰模式。`
                    : `狀態：已登錄為 ${currentUser.username}，請選擇挑戰模式。`;
                await refreshLeaderboard();
                return true;
            } catch (error) {
                if (!options.silent) {
                    const detail = error.message || '未知錯誤';
                    const hint = detail.includes('用戶名或密碼錯誤') ? '（首次註冊需固定密碼，後續請使用同一密碼登錄）' : '';
                    displayError(`登錄失敗：${detail}${hint}`, statusDiv);
                }
                clearCurrentUser();
                return false;
            } finally {
                setLoadingState(loginBtn, false, '登錄');
            }
        }

        function formatPeriodLabel(scope, periodInfo) {
            if (!periodInfo) return '';
            if (scope === 'daily') return `日期：${periodInfo.dailyKey || '-'}`;
            if (scope === 'weekly') return `週次：${periodInfo.weeklyKey || '-'}`;
            return '統計範圍：全部歷史';
        }

        function renderLeaderboard() {
            if (!leaderboardListDiv || !leaderboardMetaDiv) return;
            const rows = Array.isArray(leaderboardState[leaderboardScope]) ? leaderboardState[leaderboardScope] : [];
            leaderboardMetaDiv.textContent = formatPeriodLabel(leaderboardScope, leaderboardState.period);

            if (!rows.length) {
                leaderboardListDiv.innerHTML = '<div class="leaderboard-empty">暫無數據，快來搶首榜。</div>';
                return;
            }

            leaderboardListDiv.innerHTML = rows.map((entry, index) => {
                const isMe = currentUser && entry.userId === currentUser.userId;
                const safeName = escapeHtml(entry.username);
                const tierName = escapeHtml(entry.tier?.tierName || '工蜂');
                const tierMode = escapeHtml(entry.tier?.modeName || '常規排位');
                const points = Number(entry.points || 0);
                const attempts = Number(entry.attempts || 0);
                const avgScore = Number(entry.avgScore || 0);
                return `<div class="leaderboard-row ${isMe ? 'me' : ''}">
                    <div class="leaderboard-rank">#${index + 1}</div>
                    <div class="leaderboard-user">
                        <div class="leaderboard-user-name">${safeName}</div>
                        <div class="leaderboard-user-tier">${tierName} · ${tierMode}</div>
                    </div>
                    <div class="leaderboard-score">${points}
                        <small>參與 ${attempts} 次｜均分 ${avgScore.toFixed(1)}</small>
                    </div>
                </div>`;
            }).join('');
        }

        async function refreshLeaderboard() {
            try {
                const data = await requestJson(
                    '/leaderboard?limit=20',
                    { method: 'GET', headers: getAuthHeaders() },
                    { retries: 1, timeoutMs: 15000 }
                );
                leaderboardState = data;
                if (data.me && currentUser && data.me.userId === currentUser.userId) {
                    currentUser.stats = data.me.stats;
                    renderAccountStatus();
                }
            } catch (error) {
                console.error('Leaderboard fetch failed:', error);
                if (error?.status === 401) {
                    clearCurrentUser();
                    statusDiv.textContent = '狀態：登錄已過期，請重新登錄。';
                }
                leaderboardState = { period: { dailyKey: '', weeklyKey: '' }, total: [], weekly: [], daily: [], me: null };
            }
            renderLeaderboard();
        }

        // --- Utility Functions ---
        function setLoadingState(button, loading, defaultText = '操作') {
            if (!button) return;
            button.disabled = loading;
            button.textContent = loading ? '稍候...' : defaultText;
            button.classList.toggle('loading-active', loading);
        }

        function resetUploadWidgets(infoText = '') {
            compressedImageBlob = null;
            imagePreview.style.display = 'none';
            imagePreview.src = '#';
            imageUploadInput.value = '';
            compressionInfo.textContent = infoText;
            const compInfoError = compressionInfo.querySelector('.error-message');
            if (compInfoError) compInfoError.remove();
            submitBtn.disabled = true;
        }

        // (Req 8) Extended resetUI
        function resetUI() {
            statusDiv.textContent = '狀態：選擇挑戰模式...';
            statusDiv.style.display = 'block';
            resultDiv.style.display = 'none';
            resultDiv.innerHTML = '';
            resultDiv.classList.remove('full-marks-celebration');
            chapterSelectionDiv.style.display = 'none'; // Hide chapter selection
            chapterSelectionDiv.innerHTML = '';      // Clear chapter selection content
            questionsDiv.style.display = 'none';
            uploadSection.style.display = 'none';
            questionListDiv.innerHTML = '';
            questionsTitle.textContent = '筆墨伺候 (共 8 分)'; // Reset title

            currentQuestions = [];
            currentChallengeType = null;
            currentChallengeIdentifier = null;
            currentChapterTitle = '';
            isSubmitting = false;
            isLoading = false; // Reset general loading flag

            resetUploadWidgets();
            backToChaptersBtn.style.display = 'none';

            // Reset button states
            setLoadingState(gaokaoChallengeBtn, false, '挑戰高考');
            setLoadingState(selectChapterBtn, false, '選篇挑戰');
            setLoadingState(submitBtn, false, '提交墨寶');

            // Ensure other buttons are re-enabled if they were disabled by a loading state
            gaokaoChallengeBtn.disabled = false;
            selectChapterBtn.disabled = false;
        }

        function displayError(message, container = statusDiv) {
            console.error("Error:", message);
            const safeMessage = escapeHtml(message);
            if (container) {
                let displayMessage = safeMessage;
                // Add specific messages if needed, similar to before
                if (safeMessage.toLowerCase().includes("overloaded") || safeMessage.includes("503") || safeMessage.includes("429")) displayMessage = `AI 服務暫時忙碌，請稍後再試。<br><small>(${safeMessage})</small>`;
                else if (safeMessage.includes("AI API Error")) displayMessage = `與 AI 服務通信時發生錯誤，請稍後再試。<br><small>(${safeMessage})</small>`;
                else if (safeMessage.includes("無法獲取")) displayMessage = `無法加載所需信息，請刷新或稍後再試。<br><small>(${safeMessage})</small>`;

                container.innerHTML = `<div class="error-message">錯誤：${displayMessage}</div>`;
                container.style.display = 'block';

                // Scroll the relevant column into view
                if (container === resultDiv || container === chapterSelectionDiv) {
                    if (rightColumn) rightColumn.scrollTo({ top: 0, behavior: 'smooth' });
                } else if (container === statusDiv || container === questionsDiv || container === uploadSection) {
                    if (leftColumn) leftColumn.scrollTo({ top: 0, behavior: 'smooth' });
                } else if (typeof container.scrollIntoView === 'function') {
                    container.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }

        function escapeHtml(unsafe) {
            if (unsafe === null || unsafe === undefined) return '';
            if (typeof unsafe !== 'string') { return String(unsafe); }
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/\"/g, "&quot;")
                .replace(/'/g, "&#39;");
        }

        // Function to display questions (used by both modes)
        function displayQuestions(questions, title = '筆墨伺候 (共 8 分)') {
            currentQuestions = questions; // Store questions locally
            questionsTitle.textContent = title; // Update the title
            questionListDiv.innerHTML = ''; // Clear previous questions

            if (!questions || questions.length === 0) {
                questionListDiv.innerHTML = '<p>未能加載題目。</p>';
                questionsDiv.style.display = 'block';
                uploadSection.style.display = 'none';
                return;
            }

            questions.forEach((q) => {
                const item = document.createElement('div');
                item.classList.add('question-item');
                const questionText = q.question || '';
                // Format blanks, remove source/details (Req 3)
                const formattedQuestion = escapeHtml(questionText).replace(/_{2,}/g, '<span class="underline-blank"> </span>');
                item.innerHTML = `<p><span class="question-text">${formattedQuestion}</span></p>`; // No details span
                questionListDiv.appendChild(item);
            });

            questionsDiv.style.display = 'block';
            uploadSection.style.display = 'block'; // Show upload section
            submitBtn.disabled = !compressedImageBlob; // Enable submit only if image already selected+compressed
            backToChaptersBtn.style.display = currentChallengeType === 'chapter' ? 'inline-block' : 'none';

            // Scroll left column to top
            if (leftColumn) leftColumn.scrollTo({ top: 0, behavior: 'smooth' });
            else questionsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function renderChapterList(chapters) {
            chapterSelectionDiv.innerHTML = '<h2>選擇篇目開始挑戰</h2><ul class="chapter-list"></ul>';
            const listElement = chapterSelectionDiv.querySelector('.chapter-list');
            if (!listElement) return;

            if (!chapters || chapters.length === 0) {
                listElement.innerHTML = '<li>未能加載到任何篇目。</li>';
                return;
            }

            chapters.forEach(chapter => {
                const listItem = document.createElement('li');
                listItem.classList.add('chapter-list-item');
                const button = document.createElement('button');
                button.dataset.order = chapter.order;
                button.innerHTML = `<span class="chapter-order">${escapeHtml(chapter.order)}.</span> <span class="chapter-title">${escapeHtml(chapter.title)}</span>`;
                button.addEventListener('click', handleChapterSelection);
                listItem.appendChild(button);
                listElement.appendChild(listItem);
            });
        }

        function openChapterSelection() {
            if (!Array.isArray(chapterCache) || chapterCache.length === 0) {
                displayError('篇目緩存已過期，請重新點擊「選篇挑戰」。');
                return;
            }

            currentQuestions = [];
            currentChallengeType = null;
            currentChallengeIdentifier = null;
            currentChapterTitle = '';
            questionListDiv.innerHTML = '';
            questionsDiv.style.display = 'none';
            uploadSection.style.display = 'none';
            backToChaptersBtn.style.display = 'none';
            resultDiv.style.display = 'none';
            resultDiv.innerHTML = '';
            resultDiv.classList.remove('full-marks-celebration');
            resetUploadWidgets();
            chapterSelectionDiv.style.display = 'block';
            renderChapterList(chapterCache);
            statusDiv.textContent = '狀態：請選擇要挑戰的篇目';
            if (rightColumn) rightColumn.scrollTo({ top: 0, behavior: 'smooth' });
        }


        // --- Event Listeners ---

        loginBtn.addEventListener('click', async () => {
            await loginWithUsername(usernameInput.value, passwordInput.value);
        });

        usernameInput.addEventListener('keydown', async (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                await loginWithUsername(usernameInput.value, passwordInput.value);
            }
        });

        passwordInput.addEventListener('keydown', async (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                await loginWithUsername(usernameInput.value, passwordInput.value);
            }
        });

        logoutBtn.addEventListener('click', async () => {
            if (!currentUser?.token) {
                clearCurrentUser();
                statusDiv.textContent = '狀態：已退出登錄。';
                return;
            }
            setLoadingState(logoutBtn, true, '登出中');
            try {
                await requestJson('/logout', { method: 'POST', headers: getAuthHeaders() }, { retries: 0 });
            } catch (error) {
                console.warn('Logout request failed:', error);
            } finally {
                clearCurrentUser();
                statusDiv.textContent = '狀態：已退出登錄。';
                setLoadingState(logoutBtn, false, '登出');
                await refreshLeaderboard();
            }
        });

        changePasswordBtn.addEventListener('click', async () => {
            if (!currentUser?.token) {
                displayError('請先登錄，再修改密碼。', statusDiv);
                return;
            }
            const oldPassword = (oldPasswordInput.value || '').trim();
            const newPassword = (newPasswordInput.value || '').trim();
            if (oldPassword.length < 6 || newPassword.length < 6) {
                displayError('密碼至少 6 位。', statusDiv);
                return;
            }
            setLoadingState(changePasswordBtn, true, '修改中');
            try {
                const data = await requestJson(
                    '/change_password',
                    {
                        method: 'POST',
                        headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                        body: JSON.stringify({ oldPassword, newPassword }),
                    },
                    { retries: 0, timeoutMs: 20000 }
                );
                currentUser.token = data.token;
                currentUser.expiresAt = data.expiresAt;
                writeStoredToken(data.token);
                oldPasswordInput.value = '';
                newPasswordInput.value = '';
                statusDiv.textContent = '狀態：密碼修改成功。';
            } catch (error) {
                if (error?.status === 401) {
                    clearCurrentUser();
                    statusDiv.textContent = '狀態：登錄已過期，請重新登錄。';
                }
                displayError(`修改密碼失敗：${error.message || '未知錯誤'}`, statusDiv);
            } finally {
                setLoadingState(changePasswordBtn, false, '修改密碼');
            }
        });

        leaderboardTabs.forEach((tab) => {
            tab.addEventListener('click', () => {
                const scope = tab.dataset.scope;
                if (!scope || !['total', 'weekly', 'daily'].includes(scope)) return;
                leaderboardScope = scope;
                leaderboardTabs.forEach(btn => btn.classList.toggle('active', btn === tab));
                renderLeaderboard();
            });
        });

        backToChaptersBtn.addEventListener('click', () => {
            openChapterSelection();
        });

        // (Req 5) Listener for "挑戰高考" button
        gaokaoChallengeBtn.addEventListener('click', async () => {
            if (!requireLogin()) return;
            if (isLoading) return; // Prevent multiple clicks
            resetUI(); // Full reset
            isLoading = true;
            setLoadingState(gaokaoChallengeBtn, true, '正在出題');
            setLoadingState(selectChapterBtn, true); // Disable other button
            statusDiv.textContent = '正在從雲端獲取高考挑戰題組...';
            statusDiv.style.display = 'block';

            try {
                const setData = await requestJson(
                    '/start_gaokao_set',
                    { method: 'GET', headers: getAuthHeaders() },
                    { retries: 1 }
                );
                if (!setData || !setData.setId || !setData.questions || setData.questions.length === 0) {
                    throw new Error('未能從後端獲取有效的“挑戰高考”題組數據。');
                }

                currentChallengeType = 'gaokao';
                currentChallengeIdentifier = setData.setId; // Store the setId
                statusDiv.textContent = `高考挑戰題組已就緒 (ID: ${currentChallengeIdentifier.substring(0, 6)}...)！請提筆作答...`;

                const gaokaoScoreTarget = setData.questions.length * 2;
                displayQuestions(setData.questions, `挑戰高考 (${setData.questions.length}題, 共 ${gaokaoScoreTarget} 分)`);

            } catch (error) {
                console.error('Error fetching GaoKao questions:', error);
                displayError(`獲取“挑戰高考”題目時遇到問題: ${error.message || '未知錯誤'}`);
                resetUI(); // Reset fully on error
            } finally {
                isLoading = false;
                // Reset loading states, keep buttons enabled
                setLoadingState(gaokaoChallengeBtn, false, '挑戰高考');
                setLoadingState(selectChapterBtn, false, '選篇挑戰');
                gaokaoChallengeBtn.disabled = false;
                selectChapterBtn.disabled = false;
            }
        });

        // (Req 6, 8) Listener for "選篇挑戰" button
        selectChapterBtn.addEventListener('click', async () => {
            if (!requireLogin()) return;
            if (isLoading) return;
            resetUI(); // Full reset before showing chapters
            isLoading = true;
            setLoadingState(selectChapterBtn, true, '加載篇目');
            setLoadingState(gaokaoChallengeBtn, true); // Disable other button
            statusDiv.textContent = '正在加載篇目列表...';
            statusDiv.style.display = 'block';
            // Clear main result area, ensure chapter selection is visible
            resultDiv.style.display = 'none';
            resultDiv.innerHTML = '';
            chapterSelectionDiv.style.display = 'block';
            chapterSelectionDiv.innerHTML = '<div class="loading">正在加載篇目...</div>';

            // Scroll right column to top
            if (rightColumn) rightColumn.scrollTo({ top: 0, behavior: 'smooth' });

            try {
                const hasCache = Array.isArray(chapterCache) && (Date.now() - chapterCacheTime) < CHAPTER_CACHE_TTL_MS;
                const chapters = hasCache
                    ? chapterCache
                    : (await requestJson('/get_chapters', { method: 'GET', headers: getAuthHeaders() }, { retries: 1 })).chapters;

                if (!Array.isArray(chapters)) {
                    throw new Error('未能從後端獲取有效的篇目列表數據。');
                }
                if (!hasCache) {
                    chapterCache = chapters;
                    chapterCacheTime = Date.now();
                }

                // (Req 9) Display chapter list
                statusDiv.textContent = '狀態：請選擇要挑戰的篇目';
                renderChapterList(chapters);
            } catch (error) {
                console.error('Error fetching chapters:', error);
                if (error?.status === 401) {
                    clearCurrentUser();
                    statusDiv.textContent = '狀態：登錄已過期，請重新登錄。';
                }
                displayError(`獲取篇目列表時遇到問題: ${error.message || '未知錯誤'}`, chapterSelectionDiv); // Display error in chapter section
                statusDiv.textContent = '狀態：加載篇目列表失敗';
            } finally {
                isLoading = false;
                // Reset loading states, keep buttons enabled
                setLoadingState(selectChapterBtn, false, '選篇挑戰');
                setLoadingState(gaokaoChallengeBtn, false, '挑戰高考');
                gaokaoChallengeBtn.disabled = false;
                selectChapterBtn.disabled = false;
            }
        });

        // (Req 7 - part 2) Handler for clicking a chapter button
        async function handleChapterSelection(event) {
            if (isLoading) return;
            const button = event.currentTarget;
            const chapterOrder = button.dataset.order;
            if (!chapterOrder) return;

            isLoading = true;
            // Keep chapter list visible to allow quick retry if fetch fails.
            document.querySelectorAll('.chapter-list-item button').forEach(btn => btn.disabled = true);
            statusDiv.textContent = `正在加載篇目 ${chapterOrder} 的題目...`;
            statusDiv.style.display = 'block';
            questionsDiv.style.display = 'none';
            uploadSection.style.display = 'none';
            backToChaptersBtn.style.display = 'none';
            resultDiv.style.display = 'none';
            resultDiv.innerHTML = '';
            resultDiv.classList.remove('full-marks-celebration');
            resetUploadWidgets();
            currentQuestions = [];
            currentChallengeType = null;
            currentChallengeIdentifier = null;
            currentChapterTitle = '';

            try {
                const chapterQuestionsData = await requestJson(
                    `/get_chapter_questions?order=${encodeURIComponent(chapterOrder)}`,
                    { method: 'GET', headers: getAuthHeaders() },
                    { retries: 1 }
                );
                if (!chapterQuestionsData || !chapterQuestionsData.chapterOrder || !Array.isArray(chapterQuestionsData.questions)) {
                    throw new Error('未能從後端獲取有效的篇目題目數據。');
                }

                currentChallengeType = 'chapter';
                currentChallengeIdentifier = chapterQuestionsData.chapterOrder; // Store chapter order
                currentChapterTitle = chapterQuestionsData.chapterTitle || `篇目 ${currentChallengeIdentifier}`;
                statusDiv.textContent = `篇目《${currentChapterTitle}》題目已就緒！請提筆作答...`;

                // Display the questions for the selected chapter
                const questionCount = chapterQuestionsData.questions.length;
                const chapterScoreTarget = questionCount * 2;
                displayQuestions(chapterQuestionsData.questions, `《${currentChapterTitle}》 (${questionCount}題, 共 ${chapterScoreTarget} 分)`); // Update title dynamically

                // Hide chapter selection, clear results
                chapterSelectionDiv.style.display = 'none';
                chapterSelectionDiv.innerHTML = '';
                resultDiv.style.display = 'none';
                resultDiv.innerHTML = '';

            } catch (error) {
                console.error(`Error fetching questions for chapter ${chapterOrder}:`, error);
                if (error?.status === 401) {
                    clearCurrentUser();
                    statusDiv.textContent = '狀態：登錄已過期，請重新登錄。';
                }
                statusDiv.textContent = `狀態：加載篇目 ${chapterOrder} 題目失敗，可重試`;
                displayError(`加載篇目 ${chapterOrder} 題目時遇到問題: ${error.message || '未知錯誤'}`, statusDiv);
                chapterSelectionDiv.style.display = 'block';
            } finally {
                isLoading = false;
                // Re-enable buttons after loading attempt (regardless of success/failure)
                setLoadingState(gaokaoChallengeBtn, false, '挑戰高考');
                setLoadingState(selectChapterBtn, false, '選篇挑戰');
                gaokaoChallengeBtn.disabled = false;
                selectChapterBtn.disabled = false;
                // Also re-enable chapter buttons if they exist
                document.querySelectorAll('.chapter-list-item button').forEach(btn => btn.disabled = false);
            }
        }


        // --- Image Upload and Compression (Same as before) ---
        imageUploadInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            resetUploadWidgets();

            if (!file) { compressionInfo.textContent = '未選擇文件。'; return; }
            if (!file.type.startsWith('image/')) {
                displayError('請上傳有效的圖片文件 (如 JPG, PNG, WEBP)。', compressionInfo);
                imageUploadInput.value = ''; return;
            }

            try { // Preview
                const reader = new FileReader();
                reader.onload = (e) => { imagePreview.src = e.target.result; imagePreview.style.display = 'block'; }
                reader.readAsDataURL(file);
            } catch (readError) {
                console.error("File reading error:", readError);
                displayError('無法讀取圖片文件進行預覽。', compressionInfo); return;
            }

            compressionInfo.textContent = '正在優化圖片大小...';
            const options = { maxSizeMB: 1.5, maxWidthOrHeight: 1920, useWebWorker: true, preserveExif: false };

            try { // Compress
                if (typeof imageCompression !== 'function') throw new Error("Image compression library not loaded.");
                const originalSizeMb = file.size / 1024 / 1024;
                compressedImageBlob = await imageCompression(file, options);
                const compressedSizeMb = compressedImageBlob.size / 1024 / 1024;
                compressionInfo.textContent = `圖片已就緒（原始 ${originalSizeMb.toFixed(2)} MB → 壓縮 ${compressedSizeMb.toFixed(2)} MB）`;
                // Enable submit button ONLY if a challenge is active
                submitBtn.disabled = !currentChallengeType;
                if (!currentChallengeType) {
                    statusDiv.textContent = '圖片已就緒，請先選擇挑戰模式並加載題目。';
                }
            } catch (error) {
                console.error('圖片壓縮失敗:', error);
                displayError(`圖片壓縮處理失敗: ${error.message || '未知錯誤'}. 請嘗試其他圖片或刷新頁面。`, compressionInfo);
                resetUploadWidgets();
            }
        });

        // --- Submit Button Listener (Handles both modes) ---
        submitBtn.addEventListener('click', async () => {
            if (isSubmitting) return;
            if (!currentUser || !currentUser.username || !currentUser.token) {
                displayError('請先登錄後再提交。', statusDiv);
                usernameInput.focus();
                return;
            }
            if (!currentChallengeType || !currentChallengeIdentifier) {
                displayError('請先選擇挑戰模式並加載題目。', statusDiv);
                return;
            }
            if (!compressedImageBlob) {
                displayError('請先上傳作答圖片，再提交評閱。', compressionInfo);
                return;
            }

            isSubmitting = true;
            setLoadingState(submitBtn, true, '正在提交評閱');
            // Disable other main buttons during submission
            gaokaoChallengeBtn.disabled = true;
            selectChapterBtn.disabled = true;

            // Clear previous results/chapter list and show loading in result area
            const progressPhases = [
                '正在上傳圖片...',
                '正在識別文字...',
                '正在比對評分...',
                '正在生成反饋...',
            ];
            let progressIndex = 0;
            resultDiv.innerHTML = `<div class="loading">${progressPhases[progressIndex]}</div>`;
            resultDiv.style.display = 'block';
            chapterSelectionDiv.style.display = 'none'; // Ensure chapter list is hidden
            chapterSelectionDiv.innerHTML = '';
            if (submitProgressTimer) clearInterval(submitProgressTimer);
            submitProgressTimer = setInterval(() => {
                progressIndex = Math.min(progressIndex + 1, progressPhases.length - 1);
                resultDiv.innerHTML = `<div class="loading">${progressPhases[progressIndex]}</div>`;
            }, 18000);

            if (rightColumn) rightColumn.scrollTo({ top: 0, behavior: 'smooth' });

            const formData = new FormData();
            // Append the correct identifier based on challenge type
            if (currentChallengeType === 'gaokao') {
                formData.append('setId', currentChallengeIdentifier);
            } else if (currentChallengeType === 'chapter') {
                formData.append('chapterOrder', currentChallengeIdentifier);
            }

            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const originalExtension = imageUploadInput.files[0]?.name.split('.').pop() || 'png';
            // Include type in filename
            const filename = `moxie_${currentChallengeType}_${currentChallengeIdentifier}_${timestamp}.${originalExtension}`;
            formData.append('handwritingImage', compressedImageBlob, filename);

            try {
                const resultData = await requestJson(
                    '/submit',
                    { method: 'POST', headers: getAuthHeaders(), body: formData },
                    { retries: 0, timeoutMs: 120000 }
                );
                console.log("Result Data Received:", resultData);

                // --- Render Results ---
                // Use scoreTarget from response if available, default to 8
                const scoreTarget = resultData.scoreTarget !== undefined ? resultData.scoreTarget : 8;
                let resultHTML = `<h2>評閱結果 (${currentChallengeType === 'chapter' ? `《${escapeHtml(currentChapterTitle)}》 ` : ''}總分: ${resultData.totalScore ?? 'N/A'} / ${scoreTarget})</h2>`;
                let hintsHTML = '';

                if (resultData.ocrIssue) {
                    let ocrDisplayError = escapeHtml(resultData.ocrIssue);
                    if (ocrDisplayError.toLowerCase().includes("overloaded") || ocrDisplayError.includes("503") || ocrDisplayError.includes("429")) ocrDisplayError = `圖片識別服務暫時忙碌，部分結果可能不準確。<br><small>(${escapeHtml(resultData.ocrIssue)})</small>`;
                    hintsHTML += `<p>圖片識別提示：${ocrDisplayError}</p>`;
                }
                if (hintsHTML) resultHTML += `<div class="processing-hints">${hintsHTML}</div>`;

                if (resultData.results && Array.isArray(resultData.results)) {
                    resultData.results.forEach((res, index) => {
                        const isCorrect = res.isCorrect;
                        const score = res.score !== undefined ? res.score.toFixed(1) : 'N/A'; // Score per question
                        const recognized = escapeHtml(res.recognizedText || '[未能識別]');
                        const correct = escapeHtml(res.correctAnswer || '[標準答案缺失]');
                        let borderColor = 'var(--ghibli-border-color)'; let recognizedClass = ''; let tickOrCross = '';
                        // Score display per question might be less relevant if total score is prominent
                        // let scoreDisplay = `(得分: ${score})`;
                        let scoreDisplay = ''; // Keep it clean unless needed

                        if (!res.success || recognized.startsWith('[')) {
                            borderColor = 'var(--ghibli-warning-border)'; recognizedClass = 'unrecognized-text';
                            const failureReason = res.error ? escapeHtml(res.error) : '處理失敗';
                            tickOrCross = `<span class="incorrect-cross">✘</span> <span class="processing-failed-text">(${failureReason})</span>`;
                        } else if (isCorrect) {
                            borderColor = 'var(--ghibli-success-border)'; tickOrCross = '<span class="correct-tick">✔</span>';
                        } else {
                            borderColor = 'var(--ghibli-error-border)'; recognizedClass = 'incorrect-answer-text'; tickOrCross = '<span class="incorrect-cross">✘</span>';
                        }
                        resultHTML += `<div class="result-item" style="border-left-color: ${borderColor};">`;
                        resultHTML += `<p><strong>第 ${index + 1} 題</strong> ${scoreDisplay} ${tickOrCross}</p>`;
                        resultHTML += `<p><span class="label">識別結果:</span> <span class="recognized-text ${recognizedClass}">${recognized}</span></p>`;
                        if (!isCorrect || !res.success) resultHTML += `<p><span class="label">正確答案:</span> <span class="correct-answer-text">${correct}</span></p>`;
                        if (res.error && res.success) resultHTML += `<p class="item-hint">提示: ${escapeHtml(res.error)}</p>`;
                        resultHTML += `</div>`;
                    });
                } else {
                    resultHTML += `<div class="error-message">無法解析詳細評分結果。</div>`;
                }

                if (typeof resultData.pointsAwarded === 'number') {
                    const pointsDisplay = Math.round(Number(resultData.pointsAwarded));
                    resultHTML += `<div class="processing-hints"><p>本次積分 +${pointsDisplay}</p></div>`;
                }

                let rankBadgeHTML = '';
                if (resultData.userStats?.total) {
                    const totalStats = resultData.userStats.total;
                    const tierName = escapeHtml(totalStats.tier?.tierName || '工蜂');
                    const tierMode = escapeHtml(totalStats.tier?.modeName || '常規排位');
                    const nextTierName = totalStats.tier?.nextTierName ? escapeHtml(totalStats.tier.nextTierName) : '滿級';
                    const progressPercent = Number(totalStats.tier?.progressPercent ?? 100);
                    const totalPoints = Number(totalStats.points || 0);
                    const attempts = Number(totalStats.attempts || 0);
                    rankBadgeHTML += `<div class="rank-badge-section">`;
                    rankBadgeHTML += `<div class="badge-display">當前段位：<span>${tierName}</span>（${tierMode}）</div>`;
                    rankBadgeHTML += `<div class="rank-display">總積分 ${totalPoints} ｜參與 ${attempts} 次 ｜晉級進度 ${progressPercent}%（下一段位：${nextTierName}）</div>`;
                    rankBadgeHTML += `</div>`;
                }
                resultHTML += rankBadgeHTML;

                // Display results
                resultDiv.innerHTML = resultHTML;

                // Add feedback box
                const feedbackContainer = document.createElement('div');
                const isFullMarks = (resultData.totalScore === scoreTarget);
                if (resultData.feedback) {
                    feedbackContainer.className = `feedback-box ${isFullMarks ? 'feedback-success' : 'feedback-fail'}`;
                    const pre = document.createElement('pre');
                    pre.textContent = resultData.feedback; // Backend includes warnings
                    feedbackContainer.appendChild(pre);
                    resultDiv.classList.toggle('full-marks-celebration', isFullMarks);
                } else {
                    feedbackContainer.className = `feedback-box ${isFullMarks ? 'feedback-success' : 'feedback-fail'}`;
                    feedbackContainer.innerHTML = `<p>${escapeHtml(isFullMarks ? "滿分！表現不錯！" : `總分 ${resultData.totalScore ?? 'N/A'} / ${scoreTarget}。繼續努力！`)}</p>`;
                    resultDiv.classList.remove('full-marks-celebration');
                }
                resultDiv.appendChild(feedbackContainer); // Append feedback to results

                // Scroll results into view
                if (rightColumn) setTimeout(() => { rightColumn.scrollTo({ top: 0, behavior: 'smooth' }); }, 100);

                // Submission successful:
                // Require selecting a new challenge after each successful submission.
                currentChallengeType = null;
                currentChallengeIdentifier = null;
                uploadSection.style.display = 'none';
                resetUploadWidgets();
                statusDiv.textContent = '狀態：本輪評閱已完成。請重新選擇挑戰模式開始下一輪。';
                if (resultData.user?.username && currentUser) {
                    currentUser.username = resultData.user.username;
                }
                if (resultData.userStats && currentUser) {
                    currentUser.stats = resultData.userStats;
                    renderAccountStatus();
                }
                if (resultData.leaderboardSnapshot) {
                    leaderboardState = {
                        period: resultData.leaderboardSnapshot.period || leaderboardState.period,
                        total: Array.isArray(resultData.leaderboardSnapshot.total) ? resultData.leaderboardSnapshot.total : [],
                        weekly: Array.isArray(resultData.leaderboardSnapshot.weekly) ? resultData.leaderboardSnapshot.weekly : [],
                        daily: Array.isArray(resultData.leaderboardSnapshot.daily) ? resultData.leaderboardSnapshot.daily : [],
                        me: currentUser ? {
                            userId: currentUser.userId,
                            username: currentUser.username,
                            stats: currentUser.stats,
                        } : null,
                    };
                    renderLeaderboard();
                } else {
                    await refreshLeaderboard();
                }


            } catch (error) {
                console.error('Submit error:', error);
                if (error?.status === 401) {
                    clearCurrentUser();
                    statusDiv.textContent = '狀態：登錄已過期，請重新登錄。';
                }
                displayError(`提交或處理失敗: ${error.message || '未知客戶端錯誤'}`, resultDiv); // Display error in result area
            } finally {
                if (submitProgressTimer) {
                    clearInterval(submitProgressTimer);
                    submitProgressTimer = null;
                }
                isSubmitting = false;
                setLoadingState(submitBtn, false, '提交墨寶');
                // Re-enable main challenge buttons after submission attempt
                gaokaoChallengeBtn.disabled = false;
                selectChapterBtn.disabled = false;
            }
        });

        // --- Initial Setup ---
        resetUI();
        renderAuthControls();
        renderAccountStatus();
        (async () => {
            const storedUsername = readStoredUsername();
            if (storedUsername) {
                usernameInput.value = storedUsername;
            }

            const storedToken = readStoredToken();
            if (storedToken) {
                try {
                    const me = await requestJson(
                        '/me',
                        { method: 'GET', headers: getAuthHeaders({}, storedToken) },
                        { retries: 0, timeoutMs: 15000 }
                    );
                    currentUser = {
                        userId: me.user.userId,
                        username: me.user.username,
                        token: storedToken,
                        expiresAt: me.expiresAt,
                        stats: me.stats,
                    };
                    usernameInput.value = currentUser.username;
                    renderAuthControls();
                    renderAccountStatus();
                    statusDiv.textContent = `狀態：已恢復登錄為 ${currentUser.username}，請選擇挑戰模式。`;
                } catch (error) {
                    writeStoredToken('');
                    currentUser = null;
                    renderAuthControls();
                    renderAccountStatus();
                    if (error?.status === 401) {
                        statusDiv.textContent = '狀態：登錄已過期，請重新輸入密碼登錄。';
                    }
                }
            }

            await refreshLeaderboard();
        })();
    </script>

</body>

</html>
