<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="北大附中 孙玉磊">
    <meta name="robots" content="index, follow">
    <link rel="icon" href="https://img.bdfz.net/20250503004.webp" type="image/jpeg">
    <link rel="icon" href="/favicon.ico" sizes="any">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <title>AI 默寫</title>
    <style>
        /* --- Font --- */
        @font-face {
            font-family: 'HuWenMingChao';
            /* Assuming the paths are correct relative to the HTML file's location */
            src: url('./data/fonts/HuWenMingChaoTi.woff2') format('woff2'),
                url('./data/fonts/HuWenMingChaoTi.woff') format('woff');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        /* --- Ghibli Theme Variables --- */
        :root {
            --ghibli-bg: #fbfaf5;
            --ghibli-text: #5d5551;
            --ghibli-text-light: #9a8f8a;
            --ghibli-primary: #8aa3a3;
            --ghibli-primary-dark: #708a8a;
            --ghibli-accent1: #e0d8cc;
            --ghibli-accent2: #b8cca7;
            --ghibli-border-color: #d1c9bf;
            --ghibli-shadow: 0 3px 6px rgba(93, 85, 81, 0.08);
            --ghibli-footer-bg: #f2efea;
            --ghibli-error-bg: #faeae7;
            --ghibli-error-border: #e8cac6;
            --ghibli-error-text: #b55b5b;
            --ghibli-success-bg: #eaf3e6;
            --ghibli-success-border: #c9dcc3;
            --ghibli-success-text: #5a8e64;
            --ghibli-warning-bg: #fef9e9;
            --ghibli-warning-border: #f9efd1;
            --ghibli-warning-text: #a88a57;
            --ghibli-q-1: #ede9e1;
            --ghibli-q-2: #e8ede5;
            --ghibli-q-3: #ebe5e1;
            --ghibli-q-4: #e5eaed;
            --font-primary: 'HuWenMingChao', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            --footer-height: 60px;
            /* Define footer height as a variable */
        }

        /* --- Base & Body Styles --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-primary);
            line-height: 1.7;
            color: var(--ghibli-text);
            margin: 0;
            background-color: var(--ghibli-bg);
            /* Faded background image - path assumed correct */
            background-image:
                linear-gradient(rgba(251, 250, 245, 0.85), rgba(251, 250, 245, 0.9)),
                url('./data/img/5.jpeg');
            background-size: cover, cover;
            background-position: center center, center center;
            background-repeat: no-repeat, no-repeat;
            background-attachment: fixed, fixed;
            min-height: 100vh;
        }

        /* --- Layout Container --- */
        .page-container {
            display: flex;
            height: calc(100vh - var(--footer-height));
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }

        .left-column,
        .right-column {
            height: 100%;
            overflow-y: auto;
            padding: 30px;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .left-column::-webkit-scrollbar,
        .right-column::-webkit-scrollbar {
            display: none;
        }

        .left-column {
            flex: 1;
            min-width: 300px;
            border-right: 1px solid var(--ghibli-border-color);
        }

        .right-column {
            flex: 1.2;
            min-width: 320px;
            display: flex;
            flex-direction: column;
            background-color: rgba(255, 255, 255, 0.5);
        }

        /* --- Footer (Fixed) --- */
        footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--ghibli-footer-bg);
            border-top: 1px solid var(--ghibli-border-color);
            padding: 15px 0;
            height: var(--footer-height);
            text-align: center;
            font-size: 0.9em;
            color: var(--ghibli-text-light);
            z-index: 10;
            box-shadow: 0 -2px 5px rgba(93, 85, 81, 0.05);
        }

        footer a {
            color: var(--ghibli-text-light);
            text-decoration: underline;
        }

        footer a:hover {
            color: var(--ghibli-primary);
        }

        /* --- Responsive --- */
        @media (max-width: 800px) {
            body {
                min-height: 0;
                padding-bottom: var(--footer-height);
            }

            .page-container {
                flex-direction: column;
                height: auto;
                position: static;
            }

            .left-column,
            .right-column {
                height: auto;
                overflow-y: visible;
                width: 100%;
                flex: none;
                border-right: none;
                border-bottom: 1px solid var(--ghibli-border-color);
                padding: 20px;
            }

            .right-column {
                border-bottom: none;
            }
        }

        /* --- General Styles --- */
        h1,
        h2 {
            font-family: var(--font-primary);
            color: var(--ghibli-primary-dark);
            text-align: center;
            margin-bottom: 20px;
            font-weight: normal;
        }

        h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
        }

        h2 {
            font-size: 1.6em;
            border-bottom: 1px solid var(--ghibli-border-color);
            padding-bottom: 10px;
            margin-top: 30px;
        }

        p {
            margin-bottom: 15px;
        }

        strong {
            color: var(--ghibli-error-text);
            font-weight: normal;
        }

        a {
            color: var(--ghibli-primary);
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
            color: var(--ghibli-primary-dark);
        }

        #status,
        #questions,
        #result,
        #upload-section,
        #chapter-selection,
        .feedback-box,
        .processing-hints,
        .error-message,
        .rank-badge-section {
            margin-top: 25px;
            padding: 20px;
            border: 1px solid var(--ghibli-border-color);
            border-radius: 12px;
            background-color: rgba(255, 255, 255, 0.7);
            box-shadow: var(--ghibli-shadow);
        }

        #status {
            text-align: center;
            font-style: italic;
            color: var(--ghibli-text-light);
            background-color: transparent;
            border: none;
            box-shadow: none;
            padding: 10px 0;
        }

        #questions {
            background-color: rgba(242, 239, 234, 0.6);
        }

        #upload-section {
            border-top: 2px dashed var(--ghibli-primary);
            margin-top: 30px;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
            justify-content: center;
        }

        button {
            padding: 11px 24px;
            cursor: pointer;
            background-color: var(--ghibli-primary);
            color: var(--ghibli-bg);
            border: none;
            border-radius: 20px;
            font-size: 1em;
            font-family: var(--font-primary);
            transition: background-color 0.25s ease, transform 0.15s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 4px rgba(93, 85, 81, 0.15);
        }

        button:hover:not(:disabled) {
            background-color: var(--ghibli-primary-dark);
            box-shadow: 0 4px 8px rgba(93, 85, 81, 0.2);
        }

        button:active:not(:disabled) {
            transform: scale(0.97);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        button:disabled {
            background-color: var(--ghibli-accent1);
            color: var(--ghibli-text-light);
            cursor: not-allowed;
            opacity: 0.7;
            box-shadow: none;
        }

        button.loading-active {
            opacity: 0.8;
        }

        #submit-btn {
            background-color: var(--ghibli-accent2);
            color: var(--ghibli-text);
            width: calc(100% - 10px);
            margin-top: 20px;
        }

        #submit-btn:hover:not(:disabled) {
            background-color: #a6bb97;
        }

        #question-list {
            margin-top: 15px;
        }

        .question-item {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid transparent;
            transition: background-color 0.3s ease, border-color 0.3s ease;
            color: var(--ghibli-text);
        }

        .question-item:nth-child(4n+1) {
            background-color: var(--ghibli-q-1);
            border-color: var(--ghibli-border-color);
        }

        .question-item:nth-child(4n+2) {
            background-color: var(--ghibli-q-2);
            border-color: var(--ghibli-border-color);
        }

        .question-item:nth-child(4n+3) {
            background-color: var(--ghibli-q-3);
            border-color: var(--ghibli-border-color);
        }

        .question-item:nth-child(4n+4) {
            background-color: var(--ghibli-q-4);
            border-color: var(--ghibli-border-color);
        }

        .question-item p {
            margin: 0;
        }

        .question-text {
            display: block;
            margin-bottom: 5px;
            font-weight: normal;
            font-size: 1.1em;
            color: var(--ghibli-text);
        }

        /* Removed question-details span as per Req 3 */
        .underline-blank {
            border-bottom: 1.5px dashed var(--ghibli-text-light);
            padding: 0 0.5em;
            color: var(--ghibli-text-light);
            display: inline-block;
            min-width: 5em;
            text-align: center;
        }

        #image-upload-label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: var(--ghibli-primary-dark);
        }

        input[type="file"] {
            font-family: var(--font-primary);
            color: var(--ghibli-text);
            padding: 5px;
            margin-bottom: 15px;
        }

        input[type="file"]::file-selector-button {
            font-family: var(--font-primary);
            padding: 8px 15px;
            margin-right: 15px;
            cursor: pointer;
            background-color: var(--ghibli-accent1);
            color: var(--ghibli-text);
            border: 1px solid var(--ghibli-border-color);
            border-radius: 15px;
            transition: background-color 0.2s ease;
        }

        input[type="file"]::file-selector-button:hover {
            background-color: rgba(224, 216, 204, 0.85);
        }

        #image-preview-container {
            margin-top: 15px;
            text-align: center;
        }

        #image-preview {
            max-width: 90%;
            max-height: 350px;
            border: 1px solid var(--ghibli-border-color);
            border-radius: 8px;
            display: none;
            margin: 10px auto;
            box-shadow: var(--ghibli-shadow);
        }

        #compression-info {
            font-size: 0.9em;
            color: var(--ghibli-text-light);
            margin-top: 10px;
            text-align: center;
            min-height: 1.2em;
        }

        #result {
            background-color: rgba(255, 255, 255, 0.75);
        }

        .result-item {
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid var(--ghibli-border-color);
            border-radius: 8px;
            border-left-width: 6px;
            border-left-style: solid;
            transition: border-color 0.3s ease;
            background-color: var(--ghibli-bg);
        }

        .result-item p {
            margin: 8px 0;
        }

        .result-item strong {
            color: var(--ghibli-primary-dark);
            font-weight: bold;
        }

        .result-item .label {
            font-weight: bold;
            color: var(--ghibli-text-light);
            min-width: 75px;
            display: inline-block;
        }

        .recognized-text,
        .correct-answer-text,
        .incorrect-answer-text,
        .unrecognized-text {
            font-weight: normal;
            padding: 3px 6px;
            border-radius: 4px;
            display: inline-block;
            word-break: break-word;
            overflow-wrap: break-word;
            line-height: 1.5;
        }

        .correct-answer-text {
            color: var(--ghibli-success-text);
            background-color: var(--ghibli-success-bg);
            border: 1px solid var(--ghibli-success-border);
        }

        .incorrect-answer-text {
            color: var(--ghibli-error-text);
            background-color: var(--ghibli-error-bg);
            border: 1px solid var(--ghibli-error-border);
        }

        .unrecognized-text {
            color: var(--ghibli-text-light);
            background-color: var(--ghibli-accent1);
            font-style: italic;
            border: 1px solid var(--ghibli-border-color);
        }

        .correct-tick,
        .incorrect-cross {
            font-weight: bold;
            margin-left: 8px;
            font-size: 1.1em;
        }

        .correct-tick {
            color: var(--ghibli-success-text);
        }

        .incorrect-cross {
            color: var(--ghibli-error-text);
        }

        .processing-failed-text {
            color: var(--ghibli-warning-text);
            font-style: italic;
        }

        .error-message,
        .processing-hints,
        .feedback-box {
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-size: 1em;
            text-align: left;
            white-space: pre-wrap;
            word-wrap: break-word;
            border: 1px solid;
        }

        .error-message {
            background-color: var(--ghibli-error-bg);
            border-color: var(--ghibli-error-border);
            color: var(--ghibli-error-text);
            font-weight: bold;
        }

        .processing-hints {
            background-color: var(--ghibli-warning-bg);
            border-color: var(--ghibli-warning-border);
            color: var(--ghibli-warning-text);
        }

        .processing-hints p {
            margin: 5px 0;
            font-weight: bold;
        }

        .item-hint {
            color: var(--ghibli-warning-text);
            font-size: 0.9em;
            margin-top: 5px;
            font-style: italic;
        }

        .feedback-box {
            text-align: center;
            margin-top: 30px;
            font-size: 1.1em;
            line-height: 1.8;
        }

        .feedback-success {
            background-color: var(--ghibli-success-bg);
            border-color: var(--ghibli-success-border);
            color: var(--ghibli-success-text);
            font-weight: bold;
        }

        .feedback-fail {
            background-color: var(--ghibli-error-bg);
            border-color: var(--ghibli-error-border);
            color: var(--ghibli-error-text);
            font-weight: bold;
            font-size: 1.15em;
        }

        .feedback-box pre {
            background-color: transparent;
            padding: 0;
            border-radius: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: inherit;
            color: inherit;
            border: none;
            font-family: var(--font-primary);
            text-align: left;
            max-height: none;
            overflow: visible;
        }

        .loading {
            font-style: italic;
            color: var(--ghibli-text-light);
            text-align: center;
            padding: 30px;
            font-size: 1.1em;
            border: 1px dashed var(--ghibli-border-color);
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.6);
        }

        @keyframes celebrate-box {
            0% {
                transform: scale(1);
                box-shadow: var(--ghibli-shadow);
            }

            50% {
                transform: scale(1.01);
                box-shadow: 0 8px 16px rgba(90, 142, 100, 0.2);
            }

            100% {
                transform: scale(1);
                box-shadow: var(--ghibli-shadow);
            }
        }

        #result.full-marks-celebration {
            animation: celebrate-box 1.8s ease-in-out;
            border: 1px solid var(--ghibli-success-border);
            box-shadow: 0 5px 10px rgba(90, 142, 100, 0.15);
        }

        .rank-badge-section {
            text-align: center;
            margin-top: 25px;
            padding: 15px;
            background-color: rgba(224, 216, 204, 0.2);
            border: 1px solid var(--ghibli-border-color);
            border-radius: 8px;
        }

        .badge-display {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--ghibli-primary-dark);
        }

        .badge-display span {
            font-size: 1.6em;
            vertical-align: middle;
            margin: 0 5px;
            color: var(--ghibli-primary);
        }

        .rank-display {
            margin-top: 5px;
            font-size: 0.95em;
            color: var(--ghibli-text-light);
        }

        /* --- Styles for Chapter Selection --- (Requirement 9) */
        #chapter-selection {
            background-color: rgba(242, 239, 234, 0.7);
            padding: 25px;
        }

        #chapter-selection h2 {
            font-size: 1.4em;
            color: var(--ghibli-primary-dark);
            margin-bottom: 15px;
            border: none;
            text-align: left;
        }

        .chapter-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .chapter-list-item button {
            display: block;
            /* Make button take full width */
            width: 100%;
            text-align: left;
            padding: 12px 18px;
            margin-bottom: 8px;
            /* Space between items */
            font-family: var(--font-primary);
            font-size: 1.05em;
            color: var(--ghibli-text);
            background-color: var(--ghibli-bg);
            /* Use light bg */
            border: 1px solid var(--ghibli-border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
            box-shadow: var(--ghibli-shadow);
        }

        .chapter-list-item button:hover {
            background-color: var(--ghibli-accent1);
            border-color: var(--ghibli-primary);
            box-shadow: 0 4px 8px rgba(93, 85, 81, 0.12);
        }

        .chapter-list-item button .chapter-order {
            display: inline-block;
            min-width: 2em;
            /* Ensure alignment */
            margin-right: 10px;
            color: var(--ghibli-text-light);
            font-weight: bold;
        }

        .chapter-list-item button .chapter-title {
            font-weight: normal;
            color: var(--ghibli-text);
        }

        .chapter-list-item button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: var(--ghibli-accent1);
        }
    </style>
    <!-- External Libraries -->
    <script
        src="https://cdn.bootcdn.net/ajax/libs/browser-image-compression/2.0.2/browser-image-compression.js"></script>
</head>

<body>

    <!-- Page container holds the scrolling columns -->
    <div class="page-container">

        <!-- Left Column: Controls, Questions, Upload -->
        <div class="left-column">
            <h1>AI 默寫</h1>
            <p style="text-align: center; color: var(--ghibli-primary-dark);"><strong>高考默寫8分，放條<a
                        href="https://mf.bdfz.net" target="_blank">窺視者</a>都能拿滿！何況是你我！</strong></p>
            <p style="text-align: center; color: var(--ghibli-error-text); font-weight: bold;">
                依序分行，拍照上傳，清晰字跡！
            </p>
            <div class="button-group">
                <!-- (Requirement 4) Updated button text and added new button -->
                <button id="gaokao-challenge-btn">挑戰高考</button>
                <button id="select-chapter-btn">選篇挑戰</button>
            </div>
            <div id="status">狀態：選擇挑戰模式...</div>
            <div id="questions" style="display: none;">
                <!-- Title will be updated dynamically -->
                <h2 id="questions-title">筆墨伺候 (共 8 分)</h2>
                <p style="text-align: center; color: var(--ghibli-text-light); font-style: italic;">
                    <strong style="color: var(--ghibli-error-text);">‼️勿寫題號，一題一行，不加標點‼️ </strong>
                </p>
                <div id="question-list"></div>
            </div>
            <div id="upload-section" style="display: none;">
                <h2>拍照上傳</h2>
                <label for="image-upload" id="image-upload-label">選擇或拍攝照片:</label>
                <input type="file" id="image-upload" name="image-upload" accept="image/*">
                <div id="compression-info"></div>
                <div id="image-preview-container">
                    <img id="image-preview" src="#" alt="圖片預覽">
                </div>
                <button id="submit-btn" disabled>提交墨寶</button>
            </div>
        </div><!-- End Left Column -->

        <!-- Right Column: Results / Chapter Selection -->
        <div class="right-column">
            <!-- Container for Chapter Selection (Requirement 6) -->
            <div id="chapter-selection" style="display: none;">
                <!-- Chapter list will be injected here by JS -->
            </div>
            <!-- Container for Results (used by both modes) -->
            <div id="result" style="display: none;">
                <!-- Result content injected here -->
            </div>
        </div><!-- End Right Column -->

    </div> <!-- End Page Container -->

    <!-- Footer is OUTSIDE the page container -->
    <footer>
        <p>© Suen | <a href="https://bdfz.net/posts/moxie" target="_blank" rel="noopener noreferrer">關於 Moxie</a></p>
    </footer>

    <!-- Main Application Logic -->
    <script>
        // --- DOM Elements ---
        const statusDiv = document.getElementById('status');
        const questionsDiv = document.getElementById('questions');
        const questionsTitle = document.getElementById('questions-title'); // Get questions title H2
        const questionListDiv = document.getElementById('question-list');
        const uploadSection = document.getElementById('upload-section');
        const imageUploadInput = document.getElementById('image-upload');
        const imagePreview = document.getElementById('image-preview');
        const compressionInfo = document.getElementById('compression-info');
        const resultDiv = document.getElementById('result');
        const chapterSelectionDiv = document.getElementById('chapter-selection'); // (Req 6) Get chapter selection div
        const gaokaoChallengeBtn = document.getElementById('gaokao-challenge-btn'); // (Req 4) Renamed button
        const selectChapterBtn = document.getElementById('select-chapter-btn'); // (Req 4) New button
        const submitBtn = document.getElementById('submit-btn');
        const rightColumn = document.querySelector('.right-column');
        const leftColumn = document.querySelector('.left-column'); // Cache left column too

        // --- State Variables ---
        let currentQuestions = []; // Holds questions for the *current* challenge (either GaoKao or Chapter)
        let currentChallengeType = null; // 'gaokao' or 'chapter'
        let currentChallengeIdentifier = null; // Holds setId for 'gaokao', chapterOrder for 'chapter'
        let currentChapterTitle = ''; // Store chapter title for display
        let compressedImageBlob = null;
        let isSubmitting = false;
        let isLoading = false; // General loading state flag
        let chapterCache = null;
        let chapterCacheTime = 0;

        const API_BASE_URL = '/api';
        const API_TIMEOUT_MS = 20000;
        const API_RETRYABLE_STATUS = new Set([408, 425, 429, 500, 502, 503, 504]);
        const CHAPTER_CACHE_TTL_MS = 5 * 60 * 1000;

        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        function buildApiUrl(endpoint) {
            return `${API_BASE_URL}${endpoint.startsWith('/') ? endpoint : `/${endpoint}`}`;
        }

        async function parseApiError(response) {
            const contentType = response.headers.get('content-type') || '';
            if (contentType.includes('application/json')) {
                try {
                    const payload = await response.json();
                    if (payload && typeof payload.error === 'string') {
                        return payload.error;
                    }
                } catch (error) {
                    console.warn('Failed to parse API error JSON:', error);
                }
            }

            try {
                const text = await response.text();
                const plainText = text.replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').trim();
                return plainText ? plainText.slice(0, 180) : '';
            } catch (error) {
                console.warn('Failed to read API error text:', error);
                return '';
            }
        }

        async function requestJson(endpoint, fetchOptions = {}, requestOptions = {}) {
            const retries = Number.isInteger(requestOptions.retries) ? requestOptions.retries : 1;
            const timeoutMs = Number.isInteger(requestOptions.timeoutMs) ? requestOptions.timeoutMs : API_TIMEOUT_MS;
            const url = buildApiUrl(endpoint);
            let lastError = null;

            for (let attempt = 0; attempt <= retries; attempt++) {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

                try {
                    const response = await fetch(url, {
                        ...fetchOptions,
                        signal: controller.signal,
                    });

                    if (!response.ok) {
                        let message = await parseApiError(response);
                        if (!message) {
                            message = `HTTP 錯誤！狀態: ${response.status} ${response.statusText}`;
                        }
                        if (response.status === 404) {
                            message = `API 路徑不存在 (${endpoint})。請確認 Cloudflare Pages 部署包含 functions 目錄。`;
                        }
                        const error = new Error(message);
                        error.status = response.status;
                        throw error;
                    }

                    return await response.json();
                } catch (error) {
                    lastError = error;
                    const status = typeof error.status === 'number' ? error.status : undefined;
                    const isTimeout = error.name === 'AbortError';
                    const retryable = isTimeout || (status !== undefined && API_RETRYABLE_STATUS.has(status));

                    if (attempt < retries && retryable) {
                        await sleep(350 * (attempt + 1));
                        continue;
                    }

                    if (isTimeout) {
                        throw new Error(`請求超時（>${Math.round(timeoutMs / 1000)} 秒）`);
                    }
                    throw error;
                } finally {
                    clearTimeout(timeoutId);
                }
            }

            throw lastError || new Error('API 請求失敗');
        }

        // --- Utility Functions ---
        function setLoadingState(button, loading, defaultText = '操作') {
            if (!button) return;
            button.disabled = loading;
            button.textContent = loading ? '稍候...' : defaultText;
            button.classList.toggle('loading-active', loading);
        }

        // (Req 8) Extended resetUI
        function resetUI() {
            statusDiv.textContent = '狀態：選擇挑戰模式...';
            statusDiv.style.display = 'block';
            resultDiv.style.display = 'none';
            resultDiv.innerHTML = '';
            resultDiv.classList.remove('full-marks-celebration');
            chapterSelectionDiv.style.display = 'none'; // Hide chapter selection
            chapterSelectionDiv.innerHTML = '';      // Clear chapter selection content
            questionsDiv.style.display = 'none';
            uploadSection.style.display = 'none';
            questionListDiv.innerHTML = '';
            questionsTitle.textContent = '筆墨伺候 (共 8 分)'; // Reset title

            currentQuestions = [];
            currentChallengeType = null;
            currentChallengeIdentifier = null;
            currentChapterTitle = '';
            compressedImageBlob = null;
            isSubmitting = false;
            isLoading = false; // Reset general loading flag

            imagePreview.style.display = 'none';
            imagePreview.src = '#';
            imageUploadInput.value = '';
            compressionInfo.textContent = '';
            const compInfoError = compressionInfo.querySelector('.error-message');
            if (compInfoError) compInfoError.remove();

            submitBtn.disabled = true;

            // Reset button states
            setLoadingState(gaokaoChallengeBtn, false, '挑戰高考');
            setLoadingState(selectChapterBtn, false, '選篇挑戰');
            setLoadingState(submitBtn, false, '提交墨寶');

            // Ensure other buttons are re-enabled if they were disabled by a loading state
            gaokaoChallengeBtn.disabled = false;
            selectChapterBtn.disabled = false;
        }

        function displayError(message, container = statusDiv) {
            console.error("Error:", message);
            const safeMessage = escapeHtml(message);
            if (container) {
                let displayMessage = safeMessage;
                // Add specific messages if needed, similar to before
                if (safeMessage.toLowerCase().includes("overloaded") || safeMessage.includes("503") || safeMessage.includes("429")) displayMessage = `AI 服務暫時忙碌，請稍後再試。<br><small>(${safeMessage})</small>`;
                else if (safeMessage.includes("AI API Error")) displayMessage = `與 AI 服務通信時發生錯誤，請稍後再試。<br><small>(${safeMessage})</small>`;
                else if (safeMessage.includes("無法獲取")) displayMessage = `無法加載所需信息，請刷新或稍後再試。<br><small>(${safeMessage})</small>`;

                container.innerHTML = `<div class="error-message">錯誤：${displayMessage}</div>`;
                container.style.display = 'block';

                // Scroll the relevant column into view
                if (container === resultDiv || container === chapterSelectionDiv) {
                    if (rightColumn) rightColumn.scrollTo({ top: 0, behavior: 'smooth' });
                } else if (container === statusDiv || container === questionsDiv || container === uploadSection) {
                    if (leftColumn) leftColumn.scrollTo({ top: 0, behavior: 'smooth' });
                } else if (typeof container.scrollIntoView === 'function') {
                    container.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }

        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') { return String(unsafe); }
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/\"/g, "&quot;")
                .replace(/'/g, "&#39;");
        }

        // Function to display questions (used by both modes)
        function displayQuestions(questions, title = '筆墨伺候 (共 8 分)') {
            currentQuestions = questions; // Store questions locally
            questionsTitle.textContent = title; // Update the title
            questionListDiv.innerHTML = ''; // Clear previous questions

            if (!questions || questions.length === 0) {
                questionListDiv.innerHTML = '<p>未能加載題目。</p>';
                questionsDiv.style.display = 'block';
                uploadSection.style.display = 'none';
                return;
            }

            questions.forEach((q) => {
                const item = document.createElement('div');
                item.classList.add('question-item');
                const questionText = q.question || '';
                // Format blanks, remove source/details (Req 3)
                const formattedQuestion = escapeHtml(questionText).replace(/_{2,}/g, '<span class="underline-blank"> </span>');
                item.innerHTML = `<p><span class="question-text">${formattedQuestion}</span></p>`; // No details span
                questionListDiv.appendChild(item);
            });

            questionsDiv.style.display = 'block';
            uploadSection.style.display = 'block'; // Show upload section
            submitBtn.disabled = !compressedImageBlob; // Enable submit only if image already selected+compressed

            // Scroll left column to top
            if (leftColumn) leftColumn.scrollTo({ top: 0, behavior: 'smooth' });
            else questionsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function renderChapterList(chapters) {
            chapterSelectionDiv.innerHTML = '<h2>選擇篇目開始挑戰</h2><ul class="chapter-list"></ul>';
            const listElement = chapterSelectionDiv.querySelector('.chapter-list');
            if (!listElement) return;

            if (!chapters || chapters.length === 0) {
                listElement.innerHTML = '<li>未能加載到任何篇目。</li>';
                return;
            }

            chapters.forEach(chapter => {
                const listItem = document.createElement('li');
                listItem.classList.add('chapter-list-item');
                const button = document.createElement('button');
                button.dataset.order = chapter.order;
                button.innerHTML = `<span class="chapter-order">${escapeHtml(chapter.order)}.</span> <span class="chapter-title">${escapeHtml(chapter.title)}</span>`;
                button.addEventListener('click', handleChapterSelection);
                listItem.appendChild(button);
                listElement.appendChild(listItem);
            });
        }


        // --- Event Listeners ---

        // (Req 5) Listener for "挑戰高考" button
        gaokaoChallengeBtn.addEventListener('click', async () => {
            if (isLoading) return; // Prevent multiple clicks
            isLoading = true;
            resetUI(); // Full reset
            setLoadingState(gaokaoChallengeBtn, true, '正在出題');
            setLoadingState(selectChapterBtn, true); // Disable other button
            statusDiv.textContent = '正在從雲端獲取高考挑戰題組...';
            statusDiv.style.display = 'block';

            try {
                const setData = await requestJson('/start_gaokao_set', { method: 'GET' }, { retries: 1 });
                if (!setData || !setData.setId || !setData.questions || setData.questions.length === 0) {
                    throw new Error('未能從後端獲取有效的“挑戰高考”題組數據。');
                }

                currentChallengeType = 'gaokao';
                currentChallengeIdentifier = setData.setId; // Store the setId
                statusDiv.textContent = `高考挑戰題組已就緒 (ID: ${currentChallengeIdentifier.substring(0, 6)}...)！請提筆作答...`;

                displayQuestions(setData.questions, `挑戰高考 (${setData.questions.length}題, 共 8 分)`);

            } catch (error) {
                console.error('Error fetching GaoKao questions:', error);
                displayError(`獲取“挑戰高考”題目時遇到問題: ${error.message || '未知錯誤'}`);
                resetUI(); // Reset fully on error
            } finally {
                isLoading = false;
                // Reset loading states, keep buttons enabled
                setLoadingState(gaokaoChallengeBtn, false, '挑戰高考');
                setLoadingState(selectChapterBtn, false, '選篇挑戰');
                gaokaoChallengeBtn.disabled = false;
                selectChapterBtn.disabled = false;
            }
        });

        // (Req 6, 8) Listener for "選篇挑戰" button
        selectChapterBtn.addEventListener('click', async () => {
            if (isLoading) return;
            isLoading = true;
            resetUI(); // Full reset before showing chapters
            setLoadingState(selectChapterBtn, true, '加載篇目');
            setLoadingState(gaokaoChallengeBtn, true); // Disable other button
            statusDiv.textContent = '正在加載篇目列表...';
            statusDiv.style.display = 'block';
            // Clear main result area, ensure chapter selection is visible
            resultDiv.style.display = 'none';
            resultDiv.innerHTML = '';
            chapterSelectionDiv.style.display = 'block';
            chapterSelectionDiv.innerHTML = '<div class="loading">正在加載篇目...</div>';

            // Scroll right column to top
            if (rightColumn) rightColumn.scrollTo({ top: 0, behavior: 'smooth' });

            try {
                const hasCache = Array.isArray(chapterCache) && (Date.now() - chapterCacheTime) < CHAPTER_CACHE_TTL_MS;
                const chapters = hasCache
                    ? chapterCache
                    : (await requestJson('/get_chapters', { method: 'GET' }, { retries: 1 })).chapters;

                if (!Array.isArray(chapters)) {
                    throw new Error('未能從後端獲取有效的篇目列表數據。');
                }
                if (!hasCache) {
                    chapterCache = chapters;
                    chapterCacheTime = Date.now();
                }

                // (Req 9) Display chapter list
                statusDiv.textContent = '狀態：請選擇要挑戰的篇目';
                renderChapterList(chapters);
            } catch (error) {
                console.error('Error fetching chapters:', error);
                displayError(`獲取篇目列表時遇到問題: ${error.message || '未知錯誤'}`, chapterSelectionDiv); // Display error in chapter section
                statusDiv.textContent = '狀態：加載篇目列表失敗';
            } finally {
                isLoading = false;
                // Reset loading states, keep buttons enabled
                setLoadingState(selectChapterBtn, false, '選篇挑戰');
                setLoadingState(gaokaoChallengeBtn, false, '挑戰高考');
                gaokaoChallengeBtn.disabled = false;
                selectChapterBtn.disabled = false;
            }
        });

        // (Req 7 - part 2) Handler for clicking a chapter button
        async function handleChapterSelection(event) {
            if (isLoading) return;
            const button = event.currentTarget;
            const chapterOrder = button.dataset.order;
            if (!chapterOrder) return;

            isLoading = true;
            resetUI(); // Reset UI before loading chapter questions
            // Briefly disable all chapter buttons during load
            document.querySelectorAll('.chapter-list-item button').forEach(btn => btn.disabled = true);
            statusDiv.textContent = `正在加載篇目 ${chapterOrder} 的題目...`;
            statusDiv.style.display = 'block';

            try {
                const chapterQuestionsData = await requestJson(
                    `/get_chapter_questions?order=${encodeURIComponent(chapterOrder)}`,
                    { method: 'GET' },
                    { retries: 1 }
                );
                if (!chapterQuestionsData || !chapterQuestionsData.chapterOrder || !Array.isArray(chapterQuestionsData.questions)) {
                    throw new Error('未能從後端獲取有效的篇目題目數據。');
                }

                currentChallengeType = 'chapter';
                currentChallengeIdentifier = chapterQuestionsData.chapterOrder; // Store chapter order
                currentChapterTitle = chapterQuestionsData.chapterTitle || `篇目 ${currentChallengeIdentifier}`;
                statusDiv.textContent = `篇目《${currentChapterTitle}》題目已就緒！請提筆作答...`;

                // Display the questions for the selected chapter
                const questionCount = chapterQuestionsData.questions.length;
                displayQuestions(chapterQuestionsData.questions, `《${currentChapterTitle}》 (${questionCount}題, 共 8 分)`); // Update title dynamically

                // Hide chapter selection, clear results
                chapterSelectionDiv.style.display = 'none';
                chapterSelectionDiv.innerHTML = '';
                resultDiv.style.display = 'none';
                resultDiv.innerHTML = '';

            } catch (error) {
                console.error(`Error fetching questions for chapter ${chapterOrder}:`, error);
                displayError(`加載篇目 ${chapterOrder} 題目時遇到問題: ${error.message || '未知錯誤'}`);
                resetUI(); // Reset fully on error
            } finally {
                isLoading = false;
                // Re-enable buttons after loading attempt (regardless of success/failure)
                setLoadingState(gaokaoChallengeBtn, false, '挑戰高考');
                setLoadingState(selectChapterBtn, false, '選篇挑戰');
                gaokaoChallengeBtn.disabled = false;
                selectChapterBtn.disabled = false;
                // Also re-enable chapter buttons if they exist
                document.querySelectorAll('.chapter-list-item button').forEach(btn => btn.disabled = false);
            }
        }


        // --- Image Upload and Compression (Same as before) ---
        imageUploadInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            compressedImageBlob = null;
            submitBtn.disabled = true;
            imagePreview.style.display = 'none';
            compressionInfo.textContent = '';
            const compInfoError = compressionInfo.querySelector('.error-message');
            if (compInfoError) compInfoError.remove();

            if (!file) { compressionInfo.textContent = '未選擇文件。'; return; }
            if (!file.type.startsWith('image/')) {
                displayError('請上傳有效的圖片文件 (如 JPG, PNG, WEBP)。', compressionInfo);
                imageUploadInput.value = ''; return;
            }

            try { // Preview
                const reader = new FileReader();
                reader.onload = (e) => { imagePreview.src = e.target.result; imagePreview.style.display = 'block'; }
                reader.readAsDataURL(file);
            } catch (readError) {
                console.error("File reading error:", readError);
                displayError('無法讀取圖片文件進行預覽。', compressionInfo); return;
            }

            compressionInfo.textContent = '正在優化圖片大小...';
            const options = { maxSizeMB: 1.5, maxWidthOrHeight: 1920, useWebWorker: true, preserveExif: false };

            try { // Compress
                if (typeof imageCompression !== 'function') throw new Error("Image compression library not loaded.");
                compressedImageBlob = await imageCompression(file, options);
                compressionInfo.textContent = `圖片已就緒 (大小: ${(compressedImageBlob.size / 1024 / 1024).toFixed(2)} MB)`;
                // Enable submit button ONLY if a challenge is active
                submitBtn.disabled = !currentChallengeType;
            } catch (error) {
                console.error('圖片壓縮失敗:', error);
                displayError(`圖片壓縮處理失敗: ${error.message || '未知錯誤'}. 請嘗試其他圖片或刷新頁面。`, compressionInfo);
                compressedImageBlob = null; imagePreview.style.display = 'none'; imageUploadInput.value = '';
            }
        });

        // --- Submit Button Listener (Handles both modes) ---
        submitBtn.addEventListener('click', async () => {
            if (isSubmitting || !compressedImageBlob || !currentChallengeType || !currentChallengeIdentifier) {
                if (!compressedImageBlob) alert('錯誤：圖片尚未準備好。');
                if (!currentChallengeType) alert('錯誤：未選擇挑戰模式或未加載題目。');
                return;
            }

            isSubmitting = true;
            setLoadingState(submitBtn, true, '正在提交評閱');
            // Disable other main buttons during submission
            gaokaoChallengeBtn.disabled = true;
            selectChapterBtn.disabled = true;

            // Clear previous results/chapter list and show loading in result area
            resultDiv.innerHTML = '<div class="loading">正在上傳墨寶並恭候 AI 大師評閱，請稍安勿躁...</div>';
            resultDiv.style.display = 'block';
            chapterSelectionDiv.style.display = 'none'; // Ensure chapter list is hidden
            chapterSelectionDiv.innerHTML = '';

            if (rightColumn) rightColumn.scrollTo({ top: 0, behavior: 'smooth' });

            const formData = new FormData();
            // Bug Fix: Include persistent userId for rank tracking
            formData.append('userId', getUserId());
            // Append the correct identifier based on challenge type
            if (currentChallengeType === 'gaokao') {
                formData.append('setId', currentChallengeIdentifier);
            } else if (currentChallengeType === 'chapter') {
                formData.append('chapterOrder', currentChallengeIdentifier);
            }

            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const originalExtension = imageUploadInput.files[0]?.name.split('.').pop() || 'png';
            // Include type in filename
            const filename = `moxie_${currentChallengeType}_${currentChallengeIdentifier}_${timestamp}.${originalExtension}`;
            formData.append('handwritingImage', compressedImageBlob, filename);

            try {
                const resultData = await requestJson('/submit', { method: 'POST', body: formData }, { retries: 0, timeoutMs: 120000 });
                console.log("Result Data Received:", resultData);

                // --- Render Results ---
                // Use scoreTarget from response if available, default to 8
                const scoreTarget = resultData.scoreTarget !== undefined ? resultData.scoreTarget : 8;
                let resultHTML = `<h2>評閱結果 (${currentChallengeType === 'chapter' ? `《${escapeHtml(currentChapterTitle)}》 ` : ''}總分: ${resultData.totalScore ?? 'N/A'} / ${scoreTarget})</h2>`;
                let hintsHTML = '';

                if (resultData.ocrIssue) {
                    let ocrDisplayError = escapeHtml(resultData.ocrIssue);
                    if (ocrDisplayError.toLowerCase().includes("overloaded") || ocrDisplayError.includes("503") || ocrDisplayError.includes("429")) ocrDisplayError = `圖片識別服務暫時忙碌，部分結果可能不準確。<br><small>(${escapeHtml(resultData.ocrIssue)})</small>`;
                    hintsHTML += `<p>圖片識別提示：${ocrDisplayError}</p>`;
                }
                if (hintsHTML) resultHTML += `<div class="processing-hints">${hintsHTML}</div>`;

                if (resultData.results && Array.isArray(resultData.results)) {
                    resultData.results.forEach((res, index) => {
                        const isCorrect = res.isCorrect;
                        const score = res.score !== undefined ? res.score.toFixed(1) : 'N/A'; // Score per question
                        const recognized = escapeHtml(res.recognizedText || '[未能識別]');
                        const correct = escapeHtml(res.correctAnswer || '[標準答案缺失]');
                        let borderColor = 'var(--ghibli-border-color)'; let recognizedClass = ''; let tickOrCross = '';
                        // Score display per question might be less relevant if total score is prominent
                        // let scoreDisplay = `(得分: ${score})`;
                        let scoreDisplay = ''; // Keep it clean unless needed

                        if (!res.success || recognized.startsWith('[')) {
                            borderColor = 'var(--ghibli-warning-border)'; recognizedClass = 'unrecognized-text';
                            const failureReason = res.error ? escapeHtml(res.error) : '處理失敗';
                            tickOrCross = `<span class="incorrect-cross">✘</span> <span class="processing-failed-text">(${failureReason})</span>`;
                        } else if (isCorrect) {
                            borderColor = 'var(--ghibli-success-border)'; tickOrCross = '<span class="correct-tick">✔</span>';
                        } else {
                            borderColor = 'var(--ghibli-error-border)'; recognizedClass = 'incorrect-answer-text'; tickOrCross = '<span class="incorrect-cross">✘</span>';
                        }
                        resultHTML += `<div class="result-item" style="border-left-color: ${borderColor};">`;
                        resultHTML += `<p><strong>第 ${index + 1} 題</strong> ${scoreDisplay} ${tickOrCross}</p>`;
                        resultHTML += `<p><span class="label">識別結果:</span> <span class="recognized-text ${recognizedClass}">${recognized}</span></p>`;
                        if (!isCorrect || !res.success) resultHTML += `<p><span class="label">正確答案:</span> <span class="correct-answer-text">${correct}</span></p>`;
                        if (res.error && res.success) resultHTML += `<p class="item-hint">提示: ${escapeHtml(res.error)}</p>`;
                        resultHTML += `</div>`;
                    });
                } else {
                    resultHTML += `<div class="error-message">無法解析詳細評分結果。</div>`;
                }

                // Add rank/badge section only if it exists in response (i.e., for GaoKao challenge)
                let rankBadgeHTML = '';
                if (resultData.badge || resultData.rank !== undefined) {
                    rankBadgeHTML += `<div class="rank-badge-section">`;
                    if (resultData.badge) rankBadgeHTML += `<div class="badge-display">本次獲得徽章: <span>${escapeHtml(resultData.badge)}</span></div>`;
                    if (resultData.rank !== undefined) rankBadgeHTML += `<div class="rank-display">當前段位: ${escapeHtml(convertToChineseRankFrontend(resultData.rank))}階</div>`;
                    rankBadgeHTML += `</div>`;
                }
                resultHTML += rankBadgeHTML; // Add rank/badge if available

                // Display results
                resultDiv.innerHTML = resultHTML;

                // Add feedback box
                const feedbackContainer = document.createElement('div');
                const isFullMarks = (resultData.totalScore === scoreTarget);
                if (resultData.feedback) {
                    feedbackContainer.className = `feedback-box ${isFullMarks ? 'feedback-success' : 'feedback-fail'}`;
                    const pre = document.createElement('pre');
                    pre.textContent = resultData.feedback; // Backend includes warnings
                    feedbackContainer.appendChild(pre);
                    resultDiv.classList.toggle('full-marks-celebration', isFullMarks);
                } else {
                    feedbackContainer.className = `feedback-box ${isFullMarks ? 'feedback-success' : 'feedback-fail'}`;
                    feedbackContainer.innerHTML = `<p>${escapeHtml(isFullMarks ? "滿分！表現不錯！" : `總分 ${resultData.totalScore ?? 'N/A'} / ${scoreTarget}。繼續努力！`)}</p>`;
                    resultDiv.classList.remove('full-marks-celebration');
                }
                resultDiv.appendChild(feedbackContainer); // Append feedback to results

                // Scroll results into view
                if (rightColumn) setTimeout(() => { rightColumn.scrollTo({ top: 0, behavior: 'smooth' }); }, 100);

                // Submission successful:
                // - Keep the left-side questions visible (do NOT hide/clear them)
                // - Reset only the upload widgets so the user can optionally resubmit with a clearer photo
                uploadSection.style.display = 'block';
                imageUploadInput.value = '';
                imagePreview.style.display = 'none';
                imagePreview.src = '#';
                compressedImageBlob = null;
                submitBtn.disabled = true;
                compressionInfo.textContent = '已批閱。如需重交，請重新選擇一張更清晰的照片。';


            } catch (error) {
                console.error('Submit error:', error);
                displayError(`提交或處理失敗: ${error.message || '未知客戶端錯誤'}`, resultDiv); // Display error in result area
            } finally {
                isSubmitting = false;
                setLoadingState(submitBtn, false, '提交墨寶');
                // Re-enable main challenge buttons after submission attempt
                gaokaoChallengeBtn.disabled = false;
                selectChapterBtn.disabled = false;
            }
        });

        // --- Initial Setup ---
        resetUI(); // Start in the initial state

        // --- Frontend Helper function for Chinese Rank (Bug Fix: Consistent with backend) ---
        function convertToChineseRankFrontend(rank) {
            rank = Number(rank);
            if (isNaN(rank) || rank < 0) return "未知";
            if (rank === 0) return "初窺門徑";  // Bug Fix: Match backend naming
            const nums = ["零", "一", "二", "三", "四", "五", "六", "七", "八", "九", "十"];
            if (rank >= 10) return "登峰造極";  // Bug Fix: Add highest tier
            if (rank >= 7) return `巔峰${nums[rank]}`;  // Bug Fix: High tier naming
            if (rank <= 10) return nums[rank];
            if (rank < 20) return "十" + nums[rank - 10];
            if (rank % 10 === 0 && rank < 100) return nums[Math.floor(rank / 10)] + "十";
            if (rank < 100) return nums[Math.floor(rank / 10)] + "十" + nums[rank % 10];
            return `宗師 ${rank}`;
        }

        // --- Helper function to get/create persistent user ID ---
        function getUserId() {
            let userId = localStorage.getItem('moxie_user_id');
            if (!userId) {
                userId = crypto.randomUUID();
                localStorage.setItem('moxie_user_id', userId);
            }
            return userId;
        }
    </script>

</body>

</html>
