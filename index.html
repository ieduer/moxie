<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 默寫教練</title>
    <style>
        body { font-family: sans-serif; line-height: 1.6; padding: 20px; max-width: 800px; margin: 0 auto; background-color: #f9f9f9; }
        h1 { text-align: center; color: #333; }
        strong { color: #d9534f; } /* 強調紅色 */
        #status, #questions, #result { margin-top: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 8px; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .question-item { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px dashed #eee; }
        .question-item:last-child { border-bottom: none; }
        pre { background-color: #f4f4f4; padding: 10px; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; font-size: 0.9em; }
        button { padding: 12px 20px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; font-size: 1em; transition: background-color 0.2s ease; margin-left: 5px; }
        button:hover:not(:disabled) { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .button-group { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center;}
        h2 { margin-top: 0; color: #0056b3; }
        .underline-blank { text-decoration: underline; color: #aaa; display: inline-block; min-width: 10em; text-align: center;} /* 給下劃線留空 */
        .answer-wrapper { margin-top: 10px; border: 1px solid #ddd; border-radius: 4px; background-color: #fff; }
        .canvas-container { position: relative; width: 100%; height: 150px; /* 調整畫板高度 */ border-bottom: 1px solid #eee;}
        canvas { display: block; width: 100%; height: 100%; background-color: #fff; border-radius: 4px 4px 0 0; }
        .controls { padding: 5px; text-align: right; }
        .clear-btn { background-color: #f0ad4e; font-size: 0.9em; padding: 5px 10px;}
        .clear-btn:hover { background-color: #ec971f; }
        .loading { font-style: italic; color: #555; }
    </style>
    <!-- 引入 Signature Pad 庫 -->
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
</head>
<body>
    <h1>AI 默寫教練</h1>
    <p style="text-align: center;"><strong>目標：高考默寫 8 分，必須拿滿！一分都不能少！</strong></p>

    <div class="button-group">
        <button id="get-question-btn">開始挑戰</button>
        <button id="check-backend-btn">檢查後端狀態</button>
    </div>

    <div id="status">狀態：等待操作...</div>
    <div id="questions" style="display: none;">
        <h2>請默寫以下內容 (共 8 分):</h2>
        <div id="question-list"></div>
        <button id="submit-btn" style="margin-top: 20px; width: 100%;" disabled>提交答案</button>
    </div>
    <div id="result" style="display: none;"></div>

    <script>
        const statusDiv = document.getElementById('status');
        const questionsDiv = document.getElementById('questions');
        const questionListDiv = document.getElementById('question-list');
        const resultDiv = document.getElementById('result');
        const getQuestionBtn = document.getElementById('get-question-btn');
        const checkBackendBtn = document.getElementById('check-backend-btn');
        const submitBtn = document.getElementById('submit-btn');

        let signaturePads = []; // 用於存儲所有 signature_pad 實例
        let currentQuestions = []; // 存儲當前題目數據

        function setLoadingState(button, isLoading, defaultText) {
            if (isLoading) {
                button.disabled = true;
                button.textContent = '處理中...';
            } else {
                button.disabled = false;
                button.textContent = defaultText;
            }
        }

        // 調整 Canvas 大小以適應容器
        function resizeCanvas(canvas) {
            const ratio =  Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
        }

        // 初始化 Signature Pad
        function initializeSignaturePads() {
            signaturePads = []; // 清空舊的實例
            const canvases = questionListDiv.querySelectorAll('canvas');
            canvases.forEach((canvas, index) => {
                // resizeCanvas(canvas); // 初始調整一次
                const signaturePad = new SignaturePad(canvas, {
                    penColor: "rgb(0, 0, 0)", // 設置筆觸顏色為黑色
                    backgroundColor: 'rgb(255, 255, 255)' // 確保背景是白色
                });
                signaturePads.push(signaturePad);

                // 找到對應的清除按鈕並綁定事件
                const clearButton = canvas.closest('.answer-wrapper').querySelector('.clear-btn');
                if (clearButton) {
                    clearButton.addEventListener('click', () => {
                        signaturePad.clear();
                    });
                }
            });
             // 處理窗口大小變化時 Canvas 的重繪問題 (可選優化)
             // window.addEventListener("resize", () => {
             //     canvases.forEach((canvas, index) => {
             //         resizeCanvas(canvas);
             //         signaturePads[index].clear(); // 清除內容避免變形
             //     });
             // });
        }

        // 檢查後端狀態
        checkBackendBtn.addEventListener('click', async () => {
            setLoadingState(checkBackendBtn, true, '檢查後端狀態');
            statusDiv.textContent = '正在檢查後端狀態...';
            resultDiv.style.display = 'none';
            questionsDiv.style.display = 'none';
            try {
                const response = await fetch('/api/hello');
                if (!response.ok) throw new Error(`HTTP 錯誤！狀態: ${response.status} ${response.statusText}`);
                const data = await response.json();
                statusDiv.innerHTML = `後端狀態檢查成功！<pre>${JSON.stringify(data, null, 2)}</pre>`;
            } catch (error) {
                console.error('檢查後端失敗:', error);
                statusDiv.textContent = `檢查後端失敗: ${error.message}`;
            } finally {
                setLoadingState(checkBackendBtn, false, '檢查後端狀態');
            }
        });

        // 獲取題目
        getQuestionBtn.addEventListener('click', async () => {
            setLoadingState(getQuestionBtn, true, '開始挑戰');
            statusDiv.textContent = '正在從後端獲取題目...';
            resultDiv.style.display = 'none';
            questionsDiv.style.display = 'none';
            questionListDiv.innerHTML = '';
            currentQuestions = []; // 清空當前題目

            try {
                const response = await fetch('/api/question');
                if (!response.ok) throw new Error(`HTTP 錯誤！狀態: ${response.status} ${response.statusText}`);
                const questions = await response.json();

                if (questions && questions.length > 0) {
                    currentQuestions = questions; // 保存題目數據
                    statusDiv.textContent = '題目獲取成功！請作答。';
                    questions.forEach((q, index) => {
                        const item = document.createElement('div');
                        item.classList.add('question-item');
                        const formattedQuestion = q.question.replace(/_+/g, '<span class="underline-blank"> </span>');
                        item.innerHTML = `
                            <p><strong>${index + 1}. (${q.topic || '2分'})</strong></p>
                            <p>${formattedQuestion}</p>
                            <div class="answer-wrapper">
                                <div class="canvas-container">
                                    <canvas id="canvas-${q.id}"></canvas>
                                </div>
                                <div class="controls">
                                    <button class="clear-btn" type="button">清除</button>
                                </div>
                            </div>
                        `;
                        questionListDiv.appendChild(item);
                    });
                    initializeSignaturePads(); // 初始化所有 Canvas
                    questionsDiv.style.display = 'block';
                    submitBtn.disabled = false;
                } else {
                    statusDiv.textContent = '未能獲取有效題目。後端返回空數據。';
                }
            } catch (error) {
                console.error('獲取題目失敗:', error);
                statusDiv.textContent = `獲取題目失敗: ${error.message}`;
            } finally {
                setLoadingState(getQuestionBtn, false, '開始挑戰');
            }
        });

// 提交答案
submitBtn.addEventListener('click', async () => {
                setLoadingState(submitBtn, true, '提交答案');
                resultDiv.innerHTML = '<div class="loading">正在提交答案並等待 AI 評分...</div>'; // 使用 innerHTML 添加樣式
                resultDiv.style.display = 'block';

                const answersData = [];
                let hasEmpty = false;
                signaturePads.forEach((pad, index) => {
                    // 檢查 currentQuestions[index] 是否存在
                    if (!currentQuestions || !currentQuestions[index]) {
                        console.error(`無法獲取第 ${index + 1} 題的題目信息`);
                        return; // 跳過這個無效的題目
                    }
                    const questionId = currentQuestions[index].id;

                    if (pad.isEmpty()) {
                        answersData.push({ questionId: questionId, imageDataUrl: null });
                    } else {
                        // 獲取 PNG 格式的 Base64 數據 URL (質量可以調整，但 PNG 無損更適合 OCR)
                        const dataUrl = pad.toDataURL('image/png');
                        answersData.push({ questionId: questionId, imageDataUrl: dataUrl });
                    }
                });

                 if (answersData.length !== currentQuestions.length) {
                    console.error("收集到的答案數量與題目數量不匹配！");
                    resultDiv.textContent = '提交失敗：內部錯誤，請重試。';
                    setLoadingState(submitBtn, false, '提交答案');
                    return;
                 }

                try {
                    const response = await fetch('/api/submit', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ answers: answersData }),
                    });

                    if (!response.ok) {
                         const errorData = await response.json().catch(() => ({ error: `HTTP 錯誤！狀態: ${response.status} ${response.statusText}` }));
                        throw new Error(errorData.error || `HTTP 錯誤！狀態: ${response.status}`);
                    }

                    const resultData = await response.json();

                    // --- 渲染評分結果 ---
                    let resultHTML = `<h2>評分結果 (總分: ${resultData.totalScore} / 8)</h2>`;
                    resultData.results.forEach((res, index) => {
                        resultHTML += `<div class="result-item" style="margin-bottom: 15px; padding: 10px; border: 1px solid ${res.success && res.isCorrect ? '#5cb85c' : '#d9534f'}; border-radius: 4px;">`;
                        resultHTML += `<p><strong>第 ${index + 1} 題 (得分: ${res.score !== undefined ? res.score : 'N/A'})</strong></p>`;
                        if (res.success) {
                            resultHTML += `<p>你的答案 (識別結果): <span style="font-weight: bold; color: ${res.isCorrect ? 'green' : 'red'};">${res.recognizedText || '[識別失敗]'}</span></p>`;
                            if (!res.isCorrect && res.correctAnswer) {
                                resultHTML += `<p>正確答案: <span style="font-weight: bold;">${res.correctAnswer}</span></p>`;
                                // TODO: 在此處或下方加入 AI 生成的針對性解析
                            }
                            if(res.isCorrect) {
                                 resultHTML += `<p style="color: green;">回答正確！</p>`;
                            }
                             if (res.r2Key === null && res.message === "Blank answer") {
                                resultHTML += `<p style="color: orange;">你提交了空白答案。</p>`;
                            }
                        } else {
                            resultHTML += `<p style="color: red;">處理失敗: ${res.error || '未知錯誤'}</p>`;
                        }
                         resultHTML += `</div>`;
                    });

                    // TODO: 在這裡添加 AI 生成的總體斥罵/評價
                    if (resultData.totalScore < 8) {
                         resultHTML += `<p style="color: red; font-weight: bold; margin-top: 20px; text-align:center;">總分 ${resultData.totalScore}！離滿分差 ${8 - resultData.totalScore} 分！高考默寫一分都不能丟！回去好好練！</p>`;
                         // 在這裡觸發 AI 生成更詳細的斥罵
                    } else {
                        resultHTML += `<p style="color: green; font-weight: bold; margin-top: 20px; text-align:center;">不錯，拿到滿分了！繼續保持！</p>`;
                    }

                    resultDiv.innerHTML = resultHTML;
                    // --- 渲染結束 ---

                } catch (error) {
                    console.error('提交答案失敗:', error);
                    resultDiv.textContent = `提交答案失敗: ${error.message}`;
                } finally {
                    setLoadingState(submitBtn, false, '提交答案');
                }
            });

    </script>
</body>
</html>