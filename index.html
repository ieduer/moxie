<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>墨力全開 - AI 默寫教練 (拍照版)</title>
    <style>
        /* Basic styles remain similar */
        body { font-family: sans-serif; line-height: 1.6; padding: 20px; max-width: 800px; margin: 0 auto; background-color: #f9f9f9; }
        h1 { text-align: center; color: #333; }
        strong { color: #d9534f; }
        #status, #questions, #result, #upload-section { margin-top: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 8px; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .question-item { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed #eee; }
        .question-item:last-child { border-bottom: none; }
        pre { background-color: #f4f4f4; padding: 10px; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; font-size: 0.9em; }
        button { padding: 12px 20px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; font-size: 1em; transition: background-color 0.2s ease; margin-left: 5px; }
        button:hover:not(:disabled) { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .button-group { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center;}
        h2 { margin-top: 0; color: #0056b3; }
        .underline-blank { text-decoration: underline; color: #aaa; display: inline-block; min-width: 10em; text-align: center;}
        .loading { font-style: italic; color: #555; }
        .result-item { margin-bottom: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        .result-item p { margin: 5px 0; }
        /* Styles for file upload and preview */
        #upload-section { border-top: 2px solid #007bff; margin-top: 30px; }
        #image-upload { display: block; margin-bottom: 15px; font-size: 1em; }
        #image-preview-container { margin-top: 15px; text-align: center; }
        #image-preview { max-width: 100%; max-height: 400px; border: 1px solid #ddd; border-radius: 4px; display: none; margin: 0 auto; }
        #compression-info { font-size: 0.9em; color: #666; margin-top: 5px; }
    </style>
    <!-- **引入 browser-image-compression 庫** -->
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
</head>
<body>
    <h1>墨力全開 - AI 默寫教練 (拍照版)</h1>
    <p style="text-align: center;"><strong>目標：高考默寫 8 分，必須拿滿！一分都不能少！</strong></p>
    <p style="text-align: center; color: orange; font-weight: bold;">
        請將 4 道題的答案按順序清晰寫在紙上，然後拍照上傳。確保光線充足、字跡清晰！
    </p>

    <div class="button-group">
        <button id="get-question-btn">開始挑戰</button>
        <button id="check-backend-btn">檢查後端狀態</button>
    </div>

    <div id="status">狀態：等待操作...</div>

    <div id="questions" style="display: none;">
        <h2>請在紙上書寫以下內容 (共 8 分):</h2>
        <div id="question-list"></div>
        <!-- **上傳區域移到題目列表之後** -->
    </div>

    <div id="upload-section" style="display: none;">
        <h2>拍照並上傳答案</h2>
        <label for="image-upload">選擇或拍攝照片:</label>
        <input type="file" id="image-upload" name="image-upload" accept="image/*">
        <div id="compression-info"></div>
        <div id="image-preview-container">
            <img id="image-preview" src="#" alt="圖片預覽">
        </div>
         <button id="submit-btn" style="margin-top: 20px; width: 100%;" disabled>提交答案照片</button>
    </div>

    <div id="result" style="display: none;"></div>

    <script>
        // --- 全局變量和常量 ---
        const statusDiv = document.getElementById('status');
        const questionsDiv = document.getElementById('questions');
        const questionListDiv = document.getElementById('question-list');
        const uploadSection = document.getElementById('upload-section');
        const imageUploadInput = document.getElementById('image-upload');
        const imagePreview = document.getElementById('image-preview');
        const compressionInfo = document.getElementById('compression-info');
        const resultDiv = document.getElementById('result');
        const getQuestionBtn = document.getElementById('get-question-btn');
        const checkBackendBtn = document.getElementById('check-backend-btn');
        const submitBtn = document.getElementById('submit-btn');

        let currentQuestions = [];
        let currentSetId = null; // 存儲當前題組 ID
        let compressedImageBlob = null; // 存儲壓縮後的圖片 Blob

        // --- 工具函數 ---
        function setLoadingState(button, isLoading, defaultText) {
             if (isLoading) { button.disabled = true; button.textContent = '處理中...'; }
             else { button.disabled = false; button.textContent = defaultText; }
        }

        // --- 獲取題目邏輯 (請求後端獲取題目和 setId) ---
        getQuestionBtn.addEventListener('click', async () => {
            setLoadingState(getQuestionBtn, true, '開始挑戰');
            statusDiv.textContent = '正在從後端獲取新題組...';
            resultDiv.style.display = 'none';
            questionsDiv.style.display = 'none';
            uploadSection.style.display = 'none';
            questionListDiv.innerHTML = '';
            currentQuestions = [];
            currentSetId = null;
            compressedImageBlob = null; // 清空舊圖片
            imagePreview.style.display = 'none'; // 隱藏預覽
            imageUploadInput.value = ''; // 清空文件選擇
            compressionInfo.textContent = '';
            submitBtn.disabled = true;

            try {
                // **假設後端 /api/start_set 返回 { setId: '...', questions: [...] }**
                // 這裡暫時還用 /api/question 模擬獲取題目，並手動生成 setId
                // 未來需要改成調用新的 /api/start_set 接口
                const response = await fetch('/api/question'); // TODO: 替換為 /api/start_set
                if (!response.ok) throw new Error(`HTTP 錯誤！狀態: ${response.status} ${response.statusText}`);
                const questionsData = await response.json(); // 假設返回 questions 數組

                 // TODO: 從後端獲取 setId
                 currentSetId = `set-${Date.now()}-${Math.random().toString(16).substring(2, 8)}`; // 臨時生成

                if (questionsData && questionsData.length > 0) {
                    currentQuestions = questionsData;
                    statusDiv.textContent = '獲取題組成功！請在紙上作答後拍照上傳。';
                    questions.style.display = 'block'; // 顯示題目列表
                    uploadSection.style.display = 'block'; // 顯示上傳區域

                    questionsData.forEach((q, index) => {
                        const item = document.createElement('div');
                        item.classList.add('question-item');
                        const formattedQuestion = q.question.replace(/_+/g, '<span class="underline-blank"> </span>');
                        item.innerHTML = `<p><strong>${index + 1}. (${q.topic || '2分'})</strong> ${formattedQuestion}</p>`;
                        questionListDiv.appendChild(item);
                    });
                } else {
                    statusDiv.textContent = '未能獲取有效題目。';
                }
            } catch (error) {
                console.error('獲取題目失敗:', error);
                statusDiv.textContent = `獲取題目失敗: ${error.message}`;
            } finally {
                setLoadingState(getQuestionBtn, false, '開始挑戰');
            }
        });

        // --- 處理圖片選擇和壓縮 ---
        imageUploadInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) {
                compressedImageBlob = null;
                imagePreview.style.display = 'none';
                submitBtn.disabled = true;
                compressionInfo.textContent = '';
                return;
            }

            // 檢查文件類型
            if (!file.type.startsWith('image/')) {
                alert('請選擇圖片文件！');
                imageUploadInput.value = ''; // 清空選擇
                return;
            }

            // 顯示預覽
            const reader = new FileReader();
            reader.onload = function(e) {
                imagePreview.src = e.target.result;
                imagePreview.style.display = 'block';
            }
            reader.readAsDataURL(file);

            // 壓縮圖片
            compressionInfo.textContent = '正在壓縮圖片...';
            submitBtn.disabled = true; // 壓縮時禁用提交

            const options = {
                maxSizeMB: 1,          // 最大文件大小 (MB)
                maxWidthOrHeight: 1920, // 最大寬度或高度
                useWebWorker: true,    // 使用 Web Worker 加速 (如果可用)
                // initialQuality: 0.8 // 可以設置初始質量
            };

            try {
                // **使用 browser-image-compression 庫**
                console.log(`原始圖片大小: ${(file.size / 1024 / 1024).toFixed(2)} MB`);
                compressedImageBlob = await imageCompression(file, options);
                console.log(`壓縮後圖片大小: ${(compressedImageBlob.size / 1024 / 1024).toFixed(2)} MB`);
                compressionInfo.textContent = `圖片已準備就緒 (大小: ${(compressedImageBlob.size / 1024 / 1024).toFixed(2)} MB)`;
                submitBtn.disabled = false; // 壓縮完成，啟用提交
            } catch (error) {
                console.error('圖片壓縮失敗:', error);
                compressionInfo.textContent = `圖片壓縮失敗: ${error.message}`;
                compressedImageBlob = null;
                imagePreview.style.display = 'none';
                submitBtn.disabled = true;
            }
        });


        // --- 檢查後端狀態邏輯 ---
        checkBackendBtn.addEventListener('click', async () => { /* ... 略 ... */ });

        // --- 提交答案照片邏輯 ---
        submitBtn.addEventListener('click', async () => {
            if (!compressedImageBlob) {
                alert('請先選擇並壓縮圖片！');
                return;
            }
            if (!currentSetId) {
                 alert('無法提交，缺少題組信息，請先獲取題目。');
                 return;
            }

            setLoadingState(submitBtn, true, '提交答案照片');
            resultDiv.innerHTML = '<div class="loading">正在上傳圖片並等待 AI 評分...</div>';
            resultDiv.style.display = 'block';

            // **使用 FormData 上傳**
            const formData = new FormData();
            formData.append('setId', currentSetId); // 傳遞題組 ID
            // 將 Blob 對象作為文件上傳，第三個參數是文件名
            formData.append('handwritingImage', compressedImageBlob, `answer_${currentSetId}.png`);

            try {
                const response = await fetch('/api/submit', {
                    method: 'POST',
                    // **注意：使用 FormData 時，不要手動設置 Content-Type Header**
                    // **瀏覽器會自動設置正確的 multipart/form-data 邊界**
                    body: formData,
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: `HTTP 錯誤！狀態: ${response.status} ${response.statusText}` }));
                    throw new Error(errorData.error || `HTTP 錯誤！狀態: ${response.status}`);
                }

                const resultData = await response.json();

                // --- 渲染評分結果 ---
                let resultHTML = `<h2>評分結果 (總分: ${resultData.totalScore} / 8)</h2>`;
                if (resultData.results && Array.isArray(resultData.results)) {
                    resultData.results.forEach((res, index) => {
                        const boxColor = res.success ? (res.isCorrect ? '#5cb85c' : '#d9534f') : '#777';
                        resultHTML += `<div class="result-item" style="border-color: ${boxColor};">`;
                        resultHTML += `<p><strong>第 ${index + 1} 題 (得分: ${res.score !== undefined ? res.score : 'N/A'})</strong></p>`;
                        if (res.success) {
                             // 顯示識別結果和正確答案 (如果需要)
                             resultHTML += `<p>識別結果: <span style="font-weight: bold; color: ${res.isCorrect ? 'green' : 'red'};">${res.recognizedText || '[未能識別]'}</span></p>`;
                             if (!res.isCorrect && res.correctAnswer && res.correctAnswer !== "[未找到標準答案]") {
                                 resultHTML += `<p>正確答案: <span style="font-weight: bold;">${res.correctAnswer}</span></p>`;
                             }
                             if(res.isCorrect) { resultHTML += `<p style="color: green;">回答正確！</p>`; }
                             if (res.error) { resultHTML += `<p style="color: magenta;">處理提示: ${res.error}</p>`; } // 顯示分割等錯誤
                        } else {
                            resultHTML += `<p style="color: red;">處理失敗: ${res.error || '未知錯誤'}</p>`;
                        }
                         resultHTML += `</div>`;
                    });
                } else {
                     resultHTML += `<p>無法解析評分結果。</p>`;
                }

                // 顯示總體評價/斥罵 (假設後端返回了 feedback 字段)
                if (resultData.feedback) {
                     const feedbackColor = resultData.totalScore === 8 ? 'green' : 'red';
                     resultHTML += `<p style="color: ${feedbackColor}; font-weight: bold; margin-top: 20px; text-align:center; font-size: 1.1em;">${resultData.feedback}</p>`;
                } else { // 基本的斥罵
                     if (resultData.totalScore < 8) { resultHTML += `<p style="color: red; font-weight: bold; margin-top: 20px; text-align:center; font-size: 1.1em;">總分 ${resultData.totalScore}！離滿分差 ${8 - resultData.totalScore} 分！高考默寫一分都不能丟！回去好好練！</p>`; }
                     else { resultHTML += `<p style="color: green; font-weight: bold; margin-top: 20px; text-align:center; font-size: 1.1em;">不錯，拿到滿分了！繼續保持！</p>`; }
                }

                resultDiv.innerHTML = resultHTML;

            } catch (error) {
                console.error('提交答案失敗:', error);
                resultDiv.textContent = `提交答案失敗: ${error.message}`;
            } finally {
                setLoadingState(submitBtn, false, '提交答案照片');
            }
        });

        // --- 窗口大小變化監聽器 (此版本不需要操作 Canvas) ---
        // window.addEventListener("resize", () => { ... }); // 可以移除或留空

    </script>
</body>
</html>