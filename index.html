<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AI 默寫 - Ghibli 風</title>
    <style>
        /* --- Font --- */
        @font-face {
            font-family: 'HuWenMingChao';
            src: url('./data/fonts/HuWenMingChaoTi.woff2') format('woff2'),
                 url('./data/fonts/HuWenMingChaoTi.woff') format('woff');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        /* --- Ghibli Theme Variables --- */
        :root {
            --ghibli-bg: #fbfaf5;
            --ghibli-text: #5d5551;
            --ghibli-text-light: #9a8f8a;
            --ghibli-primary: #8aa3a3;
            --ghibli-primary-dark: #708a8a;
            --ghibli-accent1: #e0d8cc;
            --ghibli-accent2: #b8cca7;
            --ghibli-border-color: #d1c9bf;
            --ghibli-shadow: 0 3px 6px rgba(93, 85, 81, 0.08);
            --ghibli-footer-bg: #f2efea;
            --ghibli-error-bg: #faeae7;
            --ghibli-error-border: #e8cac6;
            --ghibli-error-text: #b55b5b;
            --ghibli-success-bg: #eaf3e6;
            --ghibli-success-border: #c9dcc3;
            --ghibli-success-text: #5a8e64;
            --ghibli-warning-bg: #fef9e9;
            --ghibli-warning-border: #f9efd1;
            --ghibli-warning-text: #a88a57;
            --ghibli-q-1: #ede9e1;
            --ghibli-q-2: #e8ede5;
            --ghibli-q-3: #ebe5e1;
            --ghibli-q-4: #e5eaed;
            --font-primary: 'HuWenMingChao', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            --footer-height: 60px; /* Define footer height as a variable */
        }

        /* --- Base & Body Styles --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            scroll-behavior: smooth;
            /* Ensure html takes full height for body % height to work if needed */
             /* height: 100%; */ /* Usually not needed with vh units */
        }

        body {
            font-family: var(--font-primary);
            line-height: 1.7;
            color: var(--ghibli-text);
            margin: 0; /* Reset default margin */

            /* --- Background Image --- */
            /* !! REPLACE 'path/to/your/ghibli-background.jpg' with your actual image path !! */
            background-image: url('./data/img/5.jpeg'); /* Ensure path is correct */
            background-size: cover; /* Cover the entire viewport */
            background-position: center center; /* Center the image */
            background-repeat: no-repeat; /* Do not tile the image */
            background-attachment: fixed; /* Image stays fixed during scroll */
            background-color: var(--ghibli-bg); /* Fallback color */

             /* Ensure body takes at least viewport height, needed for container calc */
             min-height: 100vh;
             /* Do NOT set body overflow: hidden */
        }

        /* --- Layout Container --- */
        .page-container {
            display: flex;
             /* Calculate height: 100% viewport height MINUS footer height */
             height: calc(100vh - var(--footer-height));
             width: 100%; /* Ensure it takes full width */
             position: absolute; /* Position relative to viewport for calc to work reliably */
             top: 0;
             left: 0;
        }

        /* --- Columns (Scrollable) --- */
        .left-column, .right-column {
             /* Take full height of the calculated page-container height */
             height: 100%;
             overflow-y: auto; /* Enable vertical scroll *within* the column */
             padding: 30px;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .left-column::-webkit-scrollbar,
        .right-column::-webkit-scrollbar {
            display: none;
        }

        .left-column {
            flex: 1;
            min-width: 300px;
            border-right: 1px solid var(--ghibli-border-color);
             /* Optional: Add a subtle background if needed over the main bg image */
             /* background-color: rgba(251, 250, 245, 0.8); */
        }

        .right-column {
            flex: 1.2;
            min-width: 320px;
            display: flex;
            flex-direction: column;
             /* Optional: Add a subtle background */
             background-color: rgba(255, 255, 255, 0.5);
        }

        /* --- Footer (Fixed at Bottom) --- */
        footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--ghibli-footer-bg);
            border-top: 1px solid var(--ghibli-border-color);
            padding: 15px 0;
            height: var(--footer-height); /* Use the variable */
            text-align: center;
            font-size: 0.9em;
            color: var(--ghibli-text-light);
            z-index: 10;
            box-shadow: 0 -2px 5px rgba(93, 85, 81, 0.05);
        }
        footer a {
             color: var(--ghibli-text-light); text-decoration: underline;
         }
         footer a:hover {
              color: var(--ghibli-primary);
          }

        /* --- Responsive Design --- */
        @media (max-width: 800px) {
            /* Allow normal page scroll on mobile */
             body {
                  min-height: 0; /* Reset min-height */
                  padding-bottom: var(--footer-height); /* Still need space for fixed footer */
              }
            .page-container {
                flex-direction: column;
                height: auto; /* Allow natural height */
                position: static; /* Reset positioning */
            }
            .left-column, .right-column {
                height: auto;
                overflow-y: visible; /* Disable independent scroll */
                width: 100%;
                flex: none;
                border-right: none;
                border-bottom: 1px solid var(--ghibli-border-color);
                padding: 20px;
            }
            .right-column { border-bottom: none; }
             /* Footer remains fixed via its own style */
        }

        /* --- Other Styles (Unchanged from previous version) --- */
        h1, h2 { font-family: var(--font-primary); color: var(--ghibli-primary-dark); text-align: center; margin-bottom: 20px; font-weight: normal; }
        h1 { font-size: 2.2em; margin-bottom: 10px; }
        h2 { font-size: 1.6em; border-bottom: 1px solid var(--ghibli-border-color); padding-bottom: 10px; margin-top: 30px; }
        p { margin-bottom: 15px; }
        strong { color: var(--ghibli-error-text); font-weight: normal; }
        a { color: var(--ghibli-primary); text-decoration: none; }
        a:hover { text-decoration: underline; color: var(--ghibli-primary-dark); }
        #status, #questions, #result, #upload-section, .feedback-box, .processing-hints, .error-message, .rank-badge-section { margin-top: 25px; padding: 20px; border: 1px solid var(--ghibli-border-color); border-radius: 12px; background-color: rgba(255, 255, 255, 0.7); /* Slightly increase opacity over image */ box-shadow: var(--ghibli-shadow); }
        #status { text-align: center; font-style: italic; color: var(--ghibli-text-light); background-color: transparent; border: none; box-shadow: none; padding: 10px 0;}
        #questions { background-color: rgba(242, 239, 234, 0.6); }
        #upload-section { border-top: 2px dashed var(--ghibli-primary); margin-top: 30px; }
        .button-group { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 25px; justify-content: center; }
        button { padding: 11px 24px; cursor: pointer; background-color: var(--ghibli-primary); color: var(--ghibli-bg); border: none; border-radius: 20px; font-size: 1em; font-family: var(--font-primary); transition: background-color 0.25s ease, transform 0.15s ease, box-shadow 0.2s ease; box-shadow: 0 2px 4px rgba(93, 85, 81, 0.15); }
        button:hover:not(:disabled) { background-color: var(--ghibli-primary-dark); box-shadow: 0 4px 8px rgba(93, 85, 81, 0.2); }
        button:active:not(:disabled) { transform: scale(0.97); box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1); }
        button:disabled { background-color: var(--ghibli-accent1); color: var(--ghibli-text-light); cursor: not-allowed; opacity: 0.7; box-shadow: none; }
        button.loading-active { opacity: 0.8; }
        #submit-btn { background-color: var(--ghibli-accent2); color: var(--ghibli-text); width: calc(100% - 10px); margin-top: 20px; }
        #submit-btn:hover:not(:disabled) { background-color: #a6bb97; }
        #question-list { margin-top: 15px; }
        .question-item { margin-bottom: 15px; padding: 15px; border-radius: 8px; border: 1px solid transparent; transition: background-color 0.3s ease, border-color 0.3s ease; color: var(--ghibli-text); }
        .question-item:nth-child(4n+1) { background-color: var(--ghibli-q-1); border-color: darken(var(--ghibli-q-1), 3%); }
        .question-item:nth-child(4n+2) { background-color: var(--ghibli-q-2); border-color: darken(var(--ghibli-q-2), 3%); }
        .question-item:nth-child(4n+3) { background-color: var(--ghibli-q-3); border-color: darken(var(--ghibli-q-3), 3%); }
        .question-item:nth-child(4n+4) { background-color: var(--ghibli-q-4); border-color: darken(var(--ghibli-q-4), 3%); }
        .question-item p { margin: 0; }
        .question-text { display: block; margin-bottom: 5px; font-weight: normal; font-size: 1.1em; color: var(--ghibli-text); }
        .question-details { font-size: 0.85em; color: var(--ghibli-text-light); margin-top: 8px; }
        .underline-blank { border-bottom: 1.5px dashed var(--ghibli-text-light); padding: 0 0.5em; color: var(--ghibli-text-light); display: inline-block; min-width: 5em; text-align: center; }
        #image-upload-label { display: block; margin-bottom: 10px; font-weight: bold; color: var(--ghibli-primary-dark); }
        input[type="file"] { font-family: var(--font-primary); color: var(--ghibli-text); padding: 5px; margin-bottom: 15px; }
        input[type="file"]::file-selector-button { font-family: var(--font-primary); padding: 8px 15px; margin-right: 15px; cursor: pointer; background-color: var(--ghibli-accent1); color: var(--ghibli-text); border: 1px solid var(--ghibli-border-color); border-radius: 15px; transition: background-color 0.2s ease; }
        input[type="file"]::file-selector-button:hover { background-color: darken(var(--ghibli-accent1), 5%); }
        #image-preview-container { margin-top: 15px; text-align: center; }
        #image-preview { max-width: 90%; max-height: 350px; border: 1px solid var(--ghibli-border-color); border-radius: 8px; display: none; margin: 10px auto; box-shadow: var(--ghibli-shadow); }
        #compression-info { font-size: 0.9em; color: var(--ghibli-text-light); margin-top: 10px; text-align: center; min-height: 1.2em; }
        #result { background-color: rgba(255, 255, 255, 0.75); } /* Slightly more opaque results box */
        .result-item { margin-bottom: 15px; padding: 15px; border: 1px solid var(--ghibli-border-color); border-radius: 8px; border-left-width: 6px; border-left-style: solid; transition: border-color 0.3s ease; background-color: var(--ghibli-bg); }
        .result-item p { margin: 8px 0; }
        .result-item strong { color: var(--ghibli-primary-dark); font-weight: bold; }
        .result-item .label { font-weight: bold; color: var(--ghibli-text-light); min-width: 75px; display: inline-block;}
        .recognized-text, .correct-answer-text, .incorrect-answer-text, .unrecognized-text { font-weight: normal; padding: 3px 6px; border-radius: 4px; display: inline-block; word-break: break-word; overflow-wrap: break-word; line-height: 1.5; }
        .correct-answer-text { color: var(--ghibli-success-text); background-color: var(--ghibli-success-bg); border: 1px solid var(--ghibli-success-border); }
        .incorrect-answer-text { color: var(--ghibli-error-text); background-color: var(--ghibli-error-bg); border: 1px solid var(--ghibli-error-border); }
        .unrecognized-text { color: var(--ghibli-text-light); background-color: var(--ghibli-accent1); font-style: italic; border: 1px solid darken(var(--ghibli-accent1), 5%); }
        .correct-tick, .incorrect-cross { font-weight: bold; margin-left: 8px; font-size: 1.1em; }
        .correct-tick { color: var(--ghibli-success-text); }
        .incorrect-cross { color: var(--ghibli-error-text); }
        .processing-failed-text { color: var(--ghibli-warning-text); font-style: italic; }
        .error-message, .processing-hints, .feedback-box { border-radius: 8px; padding: 15px; margin-top: 20px; font-size: 1em; text-align: left; white-space: pre-wrap; word-wrap: break-word; border: 1px solid; }
        .error-message { background-color: var(--ghibli-error-bg); border-color: var(--ghibli-error-border); color: var(--ghibli-error-text); font-weight: bold; }
        .processing-hints { background-color: var(--ghibli-warning-bg); border-color: var(--ghibli-warning-border); color: var(--ghibli-warning-text); }
        .processing-hints p { margin: 5px 0; font-weight: bold; }
        .item-hint { color: var(--ghibli-warning-text); font-size: 0.9em; margin-top: 5px; font-style: italic; }
        .feedback-box { text-align: center; margin-top: 30px; font-size: 1.1em; line-height: 1.8; }
        .feedback-success { background-color: var(--ghibli-success-bg); border-color: var(--ghibli-success-border); color: var(--ghibli-success-text); font-weight: bold; }
        .feedback-fail { background-color: var(--ghibli-error-bg); border-color: var(--ghibli-error-border); color: var(--ghibli-error-text); font-weight: bold; font-size: 1.15em; }
        .feedback-box pre { background-color: transparent; padding: 0; border-radius: 0; white-space: pre-wrap; word-wrap: break-word; font-size: inherit; color: inherit; border: none; font-family: var(--font-primary); text-align: left; max-height: none; overflow: visible; }
        .loading { font-style: italic; color: var(--ghibli-text-light); text-align: center; padding: 30px; font-size: 1.1em; border: 1px dashed var(--ghibli-border-color); border-radius: 8px; background-color: rgba(255, 255, 255, 0.6); }
        @keyframes celebrate-box { 0% { transform: scale(1); box-shadow: var(--ghibli-shadow); } 50% { transform: scale(1.01); box-shadow: 0 8px 16px rgba(90, 142, 100, 0.2); } 100% { transform: scale(1); box-shadow: var(--ghibli-shadow); } }
        #result.full-marks-celebration { animation: celebrate-box 1.8s ease-in-out; border: 1px solid var(--ghibli-success-border); box-shadow: 0 5px 10px rgba(90, 142, 100, 0.15); }
        .rank-badge-section { text-align: center; margin-top: 25px; padding: 15px; background-color: rgba(224, 216, 204, 0.2); border: 1px solid var(--ghibli-border-color); border-radius: 8px; }
        .badge-display { font-size: 1.3em; font-weight: bold; color: var(--ghibli-primary-dark); }
        .badge-display span { font-size: 1.6em; vertical-align: middle; margin: 0 5px; color: var(--ghibli-primary); }
        .rank-display { margin-top: 5px; font-size: 0.95em; color: var(--ghibli-text-light); }

    </style>
    <!-- External Libraries -->
    <script src="https://cdn.bootcdn.net/ajax/libs/browser-image-compression/2.0.2/browser-image-compression.js"></script>
</head>
<body>

    <!-- Page container holds the scrolling columns -->
    <div class="page-container">

        <!-- Left Column: Controls, Questions, Upload -->
        <div class="left-column">
             <h1>AI 默寫</h1>
             <p style="text-align: center; color: var(--ghibli-primary-dark);"><strong>高考默寫8分，放條狗都能拿滿！何況是你我！</strong></p>
             <p style="text-align: center; color: var(--ghibli-error-text); font-weight: bold;">
                 4道題，按順序分四行，拍照上傳。確保字跡清晰！
             </p>
             <div class="button-group">
                 <button id="get-question-btn">開始挑戰</button>
             </div>
             <div id="status">狀態：等待挑戰...</div>
             <div id="questions" style="display: none;">
                 <h2>筆墨伺候 (共 8 分)</h2>
                 <p style="text-align: center; color: var(--ghibli-text-light); font-style: italic;">
                     <strong style="color: var(--ghibli-error-text);">‼️：請勿書寫題號，答案中**不要加標點符號**。‼️ </strong>
                 </p>
                 <div id="question-list"></div>
             </div>
             <div id="upload-section" style="display: none;">
                 <h2>拍照上傳</h2>
                 <label for="image-upload" id="image-upload-label">選擇或拍攝照片:</label>
                 <input type="file" id="image-upload" name="image-upload" accept="image/*">
                 <div id="compression-info"></div>
                 <div id="image-preview-container">
                     <img id="image-preview" src="#" alt="圖片預覽">
                 </div>
                  <button id="submit-btn" disabled>提交墨寶</button>
             </div>
             <!-- Add dummy content to test left scroll -->
             <!-- <div style="height:1200px; background:rgba(255,0,0,0.1);">Scroll Test Left</div> -->
        </div><!-- End Left Column -->

        <!-- Right Column: Results -->
        <div class="right-column">
            <div id="result" style="display: none;">
                <!-- Result content injected here -->
            </div>
             <!-- Add dummy content to test right scroll -->
             <!-- <div style="height:1200px; background:rgba(0,0,255,0.1);">Scroll Test Right</div> -->
        </div><!-- End Right Column -->

    </div> <!-- End Page Container -->

    <!-- Footer is OUTSIDE the page container -->
    <footer>
        <p>© Suen | <a href="https://bdfz.net/posts/moxie" target="_blank" rel="noopener noreferrer">關於 Moxie</a></p>
    </footer>

    <!-- Main Application Logic -->
    <script>
        // --- Javascript unchanged from previous version ---
        // (Paste the entire <script> block from the previous response here)
        // --- DOM Elements ---
        const statusDiv = document.getElementById('status');
        const questionsDiv = document.getElementById('questions');
        const questionListDiv = document.getElementById('question-list');
        const uploadSection = document.getElementById('upload-section');
        const imageUploadInput = document.getElementById('image-upload');
        const imagePreview = document.getElementById('image-preview');
        const compressionInfo = document.getElementById('compression-info');
        const resultDiv = document.getElementById('result');
        const getQuestionBtn = document.getElementById('get-question-btn');
        const submitBtn = document.getElementById('submit-btn');
        const rightColumn = document.querySelector('.right-column'); // Cache right column

        // --- State Variables ---
        let currentQuestions = [];
        let currentSetId = null;
        let compressedImageBlob = null;
        let isSubmitting = false;

        // --- Utility Functions ---
        function setLoadingState(button, isLoading, defaultText = '操作') {
             if (!button) return;
             button.disabled = isLoading;
             button.textContent = isLoading ? '稍候...' : defaultText;
             if (isLoading) {
                button.classList.add('loading-active');
             } else {
                button.classList.remove('loading-active');
             }
        }

        function resetUI() {
            statusDiv.textContent = '狀態：等待挑戰...';
            resultDiv.style.display = 'none';
            resultDiv.innerHTML = '';
            resultDiv.classList.remove('full-marks-celebration');
            questionsDiv.style.display = 'none';
            uploadSection.style.display = 'none';
            questionListDiv.innerHTML = '';
            currentQuestions = [];
            currentSetId = null;
            compressedImageBlob = null;
            imagePreview.style.display = 'none';
            imagePreview.src = '#';
            imageUploadInput.value = ''; // Clear file input
            compressionInfo.textContent = '';
             // Clear errors in compression info
             const compInfoError = compressionInfo.querySelector('.error-message');
             if (compInfoError) compInfoError.remove();

            submitBtn.disabled = true;
            isSubmitting = false;
            setLoadingState(getQuestionBtn, false, '開始挑戰');
            setLoadingState(submitBtn, false, '提交墨寶');
        }

        function displayError(message, container = statusDiv) {
             console.error("Error:", message);
             const safeMessage = escapeHtml(message);
             if(container) {
                 let displayMessage = safeMessage;
                 // More specific user-friendly messages
                 if (safeMessage.toLowerCase().includes("overloaded") || safeMessage.toLowerCase().includes("try again later") || safeMessage.includes("503") || safeMessage.includes("429")) {
                     displayMessage = `AI 服務暫時忙碌或請求過多，請稍後再試一次提交。<br><small>(${safeMessage})</small>`;
                 } else if (safeMessage.includes("AI API Error") || safeMessage.includes("Failed to communicate")) {
                     displayMessage = `與 AI 服務通信時發生錯誤，請檢查網絡或稍後再試。<br><small>(${safeMessage})</small>`;
                 } else if (safeMessage.includes("圖片壓縮處理失敗")) {
                      displayMessage = safeMessage; // Keep compression error as is
                 } else if (safeMessage.includes("未能從後端獲取有效")) {
                     displayMessage = `無法獲取題目，請刷新頁面或稍後再試。<br><small>(${safeMessage})</small>`;
                 } else if (safeMessage.includes("無法獲取題組信息")) {
                     displayMessage = `無法加載當前挑戰信息，可能已過期，請重新開始挑戰。<br><small>(${safeMessage})</small>`;
                 }

                container.innerHTML = `<div class="error-message">錯誤：${displayMessage}</div>`;
                container.style.display = 'block';
                // Scroll the relevant column into view if possible
                if (container === resultDiv && rightColumn) {
                    rightColumn.scrollTo({ top: 0, behavior: 'smooth' });
                } else if (container !== statusDiv && typeof container.scrollIntoView === 'function') { // Check if scrollIntoView exists
                     container.scrollIntoView({ behavior: 'smooth', block: 'center' });
                 }
             }
        }

        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') { return String(unsafe); }
            return unsafe
                 .replace(/&/g, "&")
                 .replace(/</g, "<")
                 .replace(/>/g, ">")
                 // << FINAL CORRECTION: Use single quotes for the replacement string literal >>
                 .replace(/"/g, '"')
                 // << END FINAL CORRECTION >>
                 .replace(/'/g, "'"); // Ensure this line ends with a semicolon if it's the last in the chain for the return statement.
         }

        // --- Event Listeners ---
        getQuestionBtn.addEventListener('click', async () => {
            resetUI();
            setLoadingState(getQuestionBtn, true, '正在出題');
            statusDiv.textContent = '正在從雲端獲取新題組...';
            statusDiv.style.display = 'block';

            try {
                const response = await fetch('/api/start_set');
                 if (!response.ok) {
                     let errorMsg = `HTTP 錯誤！狀態: ${response.status} ${response.statusText}`;
                     try { const errorData = await response.json(); errorMsg = errorData.error || errorMsg; } catch (e) {}
                     throw new Error(errorMsg);
                 }
                const setData = await response.json();
                if (!setData || !setData.setId || !setData.questions || setData.questions.length === 0) {
                    console.error('Invalid data from /api/start_set:', setData);
                    throw new Error('未能從後端獲取有效的題組數據。');
                }

                currentSetId = setData.setId;
                currentQuestions = setData.questions;
                statusDiv.textContent = `題組已就緒 (ID: ${currentSetId.substring(0, 6)}...)！請提筆作答...`;
                questionsDiv.style.display = 'block';
                uploadSection.style.display = 'block';
                questionListDiv.innerHTML = '';
                currentQuestions.forEach((q) => {
                    const item = document.createElement('div');
                    item.classList.add('question-item');
                    const questionText = q.question || '';
                    const formattedQuestion = escapeHtml(questionText).replace(/_{2,}/g, '<span class="underline-blank"> </span>');
                    const sourceText = escapeHtml(q.source || "未知類型");
                    const detailsString = `(類型: ${sourceText})`;
                    item.innerHTML = `<p><span class="question-text">${formattedQuestion}</span><span class="question-details">${detailsString}</span></p>`;
                    questionListDiv.appendChild(item);
                });
                // Scroll left column to top when new questions load
                 const leftColumn = document.querySelector('.left-column');
                 if (leftColumn) leftColumn.scrollTo({ top: 0, behavior: 'smooth' });
                 else questionsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' }); // Fallback

            } catch (error) {
                console.error('Error fetching questions:', error);
                displayError(`獲取題目時遇到問題: ${error.message || '未知錯誤'}`);
                resetUI();
            } finally {
                setLoadingState(getQuestionBtn, false, '開始挑戰');
            }
        });

        imageUploadInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            compressedImageBlob = null;
            submitBtn.disabled = true;
            imagePreview.style.display = 'none';
            compressionInfo.textContent = '';
            const compInfoError = compressionInfo.querySelector('.error-message');
            if (compInfoError) compInfoError.remove();

            if (!file) { compressionInfo.textContent = '未選擇文件。'; return; }
            if (!file.type.startsWith('image/')) {
                displayError('請上傳有效的圖片文件 (如 JPG, PNG, WEBP)。', compressionInfo);
                imageUploadInput.value = ''; return;
            }

            try { // Preview
                const reader = new FileReader();
                reader.onload = (e) => { imagePreview.src = e.target.result; imagePreview.style.display = 'block'; }
                reader.readAsDataURL(file);
             } catch (readError) {
                 console.error("File reading error:", readError);
                 displayError('無法讀取圖片文件進行預覽。', compressionInfo); return;
             }

            compressionInfo.textContent = '正在優化圖片大小...';
            console.log(`原始圖片: ${file.name}, 大小: ${(file.size / 1024 / 1024).toFixed(2)} MB`);
            const options = { maxSizeMB: 1.5, maxWidthOrHeight: 1920, useWebWorker: true, preserveExif: false };

            try { // Compress
                 if (typeof imageCompression !== 'function') throw new Error("Image compression library not loaded.");
                compressedImageBlob = await imageCompression(file, options);
                console.log(`壓縮後圖片大小: ${(compressedImageBlob.size / 1024 / 1024).toFixed(2)} MB`);
                compressionInfo.textContent = `圖片已就緒 (大小: ${(compressedImageBlob.size / 1024 / 1024).toFixed(2)} MB)`;
                submitBtn.disabled = false;
            } catch (error) {
                console.error('圖片壓縮失敗:', error);
                displayError(`圖片壓縮處理失敗: ${error.message || '未知錯誤'}. 請嘗試其他圖片或刷新頁面。`, compressionInfo);
                compressedImageBlob = null; imagePreview.style.display = 'none'; imageUploadInput.value = '';
            }
        });

        submitBtn.addEventListener('click', async () => {
            if (isSubmitting || !compressedImageBlob || !currentSetId) {
                if (!compressedImageBlob) alert('錯誤：圖片尚未準備好。');
                if (!currentSetId) alert('錯誤：缺少題組信息。');
                return;
            }

            isSubmitting = true;
            setLoadingState(submitBtn, true, '正在提交評閱');
            resultDiv.innerHTML = '<div class="loading">正在上傳墨寶並恭候 AI 大師評閱，請稍安勿躁...</div>';
            resultDiv.style.display = 'block';
            if (rightColumn) rightColumn.scrollTo({ top: 0, behavior: 'smooth' });

            const formData = new FormData();
            formData.append('setId', currentSetId);
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const originalExtension = imageUploadInput.files[0]?.name.split('.').pop() || 'png';
            const filename = `moxie_${currentSetId.substring(0, 6)}_${timestamp}.${originalExtension}`;
            formData.append('handwritingImage', compressedImageBlob, filename);

            try {
                const response = await fetch('/api/submit', { method: 'POST', body: formData });
                if (!response.ok) {
                    let errorMsg = `提交失敗！服務器響應: ${response.status} ${response.statusText}`;
                    try { const errorData = await response.json(); errorMsg = errorData.error || errorMsg; } catch (e) {}
                    throw new Error(errorMsg);
                }
                const resultData = await response.json();
                console.log("Result Data Received:", resultData);

                // --- Render Results ---
                let resultHTML = `<h2>評閱結果 (總分: ${resultData.totalScore ?? 'N/A'} / 8)</h2>`;
                let hintsHTML = '';
                if (resultData.ocrIssue) {
                    let ocrDisplayError = escapeHtml(resultData.ocrIssue);
                     if (ocrDisplayError.toLowerCase().includes("overloaded") || ocrDisplayError.includes("503") || ocrDisplayError.includes("429")) {
                         ocrDisplayError = `圖片識別服務暫時忙碌，部分結果可能不準確。<br><small>(${escapeHtml(resultData.ocrIssue)})</small>`;
                     }
                    hintsHTML += `<p>圖片識別提示：${ocrDisplayError}</p>`;
                }
                if (hintsHTML) resultHTML += `<div class="processing-hints">${hintsHTML}</div>`;

                if (resultData.results && Array.isArray(resultData.results)) {
                    resultData.results.forEach((res, index) => {
                        const isCorrect = res.isCorrect;
                        const score = res.score !== undefined ? res.score.toFixed(1) : 'N/A';
                        const recognized = escapeHtml(res.recognizedText || '[未能識別]');
                        const correct = escapeHtml(res.correctAnswer || '[標準答案缺失]');
                        let borderColor = 'var(--ghibli-border-color)'; let recognizedClass = ''; let tickOrCross = '';
                        let scoreDisplay = `(得分: ${score})`;

                        if (!res.success || recognized.startsWith('[')) {
                             borderColor = 'var(--ghibli-warning-border)'; recognizedClass = 'unrecognized-text';
                             const failureReason = res.error ? escapeHtml(res.error) : '處理失敗';
                             tickOrCross = `<span class="incorrect-cross">✘</span> <span class="processing-failed-text">(${failureReason})</span>`;
                         } else if (isCorrect) {
                            borderColor = 'var(--ghibli-success-border)'; tickOrCross = '<span class="correct-tick">✔</span>';
                        } else {
                            borderColor = 'var(--ghibli-error-border)'; recognizedClass = 'incorrect-answer-text'; tickOrCross = '<span class="incorrect-cross">✘</span>';
                        }
                        resultHTML += `<div class="result-item" style="border-left-color: ${borderColor};">`;
                        resultHTML += `<p><strong>第 ${index + 1} 題</strong> ${scoreDisplay} ${tickOrCross}</p>`;
                        resultHTML += `<p><span class="label">識別結果:</span> <span class="recognized-text ${recognizedClass}">${recognized}</span></p>`;
                        if (!isCorrect || !res.success) resultHTML += `<p><span class="label">正確答案:</span> <span class="correct-answer-text">${correct}</span></p>`;
                        if (res.error && res.success) resultHTML += `<p class="item-hint">提示: ${escapeHtml(res.error)}</p>`;
                        resultHTML += `</div>`;
                    });
                } else {
                    resultHTML += `<div class="error-message">無法解析詳細評分結果。</div>`;
                    console.warn("Missing or invalid 'results' array:", resultData);
                }

                 let rankBadgeHTML = '';
                 if (resultData.badge || resultData.rank !== undefined) {
                     rankBadgeHTML += `<div class="rank-badge-section">`;
                     if (resultData.badge) rankBadgeHTML += `<div class="badge-display">本次獲得徽章: <span>${escapeHtml(resultData.badge)}</span></div>`;
                     if (resultData.rank !== undefined) rankBadgeHTML += `<div class="rank-display">當前段位: ${escapeHtml(convertToChineseRankFrontend(resultData.rank))}階</div>`;
                     rankBadgeHTML += `</div>`;
                 }
                 resultHTML += rankBadgeHTML;
                 resultDiv.innerHTML = resultHTML;

                 const feedbackContainer = document.createElement('div');
                 if (resultData.feedback) {
                     const isFullMarks = (resultData.totalScore === 8);
                     feedbackContainer.className = `feedback-box ${isFullMarks ? 'feedback-success' : 'feedback-fail'}`;
                     const pre = document.createElement('pre');
                     pre.textContent = resultData.feedback; // Backend includes warnings now
                     feedbackContainer.appendChild(pre);
                     resultDiv.classList.toggle('full-marks-celebration', isFullMarks);
                 } else { // Basic fallback
                    const isFullMarks = (resultData.totalScore === 8);
                    feedbackContainer.className = `feedback-box ${isFullMarks ? 'feedback-success' : 'feedback-fail'}`;
                    feedbackContainer.innerHTML = `<p>${escapeHtml(isFullMarks ? "滿分！表現不錯！" : `總分 ${resultData.totalScore ?? 'N/A'}。未達滿分，還需努力。`)}</p>`;
                    resultDiv.classList.remove('full-marks-celebration');
                 }
                 resultDiv.appendChild(feedbackContainer);

                 if (rightColumn) setTimeout(() => { rightColumn.scrollTo({ top: 0, behavior: 'smooth' }); }, 100);

            } catch (error) {
                 console.error('Submit error:', error);
                 displayError(`提交或處理失敗: ${error.message || '未知客戶端錯誤'}`, resultDiv);
            } finally {
                isSubmitting = false;
                setLoadingState(submitBtn, false, '提交墨寶');
            }
        });

        // --- Initial Setup ---
        resetUI();

        // --- Frontend Helper function for Chinese Rank ---
        function convertToChineseRankFrontend(rank) {
            rank = Number(rank);
            if (isNaN(rank) || rank < 0) return "未知"; if (rank === 0) return "初窺";
            const nums = ["零", "一", "二", "三", "四", "五", "六", "七", "八", "九", "十"];
            if (rank <= 10) return nums[rank]; if (rank < 20) return "十" + nums[rank - 10];
            if (rank % 10 === 0 && rank < 100) return nums[Math.floor(rank / 10)] + "十";
            if (rank < 100) return nums[Math.floor(rank / 10)] + "十" + nums[rank % 10];
            return `宗師 ${rank}`;
        }
    </script>
    <!-- Clarity Tracking -->
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "qz8lnht4jz");
    </script>

</body>
</html>